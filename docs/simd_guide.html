<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--  This file is generated by Nim. -->
<html xmlns="https://www.w3.org/1999/xhtml" xml:lang="en" lang="en" data-theme="auto">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>simd_guide</title>

<!-- Google fonts -->
<link href='https://fonts.googleapis.com/css?family=Lato:400,600,900' rel='stylesheet' type='text/css'/>
<link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,500,600' rel='stylesheet' type='text/css'/>

<!-- Favicon -->
<link rel="shortcut icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAUAAAAF////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAIAAABbAAAAlQAAAKIAAACbAAAAmwAAAKIAAACVAAAAWwAAAAL///8A////AP///wD///8A////AAAAABQAAADAAAAAYwAAAA3///8A////AP///wD///8AAAAADQAAAGMAAADAAAAAFP///wD///8A////AP///wAAAACdAAAAOv///wD///8A////AP///wD///8A////AP///wD///8AAAAAOgAAAJ3///8A////AP///wAAAAAnAAAAcP///wAAAAAoAAAASv///wD///8A////AP///wAAAABKAAAAKP///wAAAABwAAAAJ////wD///8AAAAAgQAAABwAAACIAAAAkAAAAJMAAACtAAAAFQAAABUAAACtAAAAkwAAAJAAAACIAAAAHAAAAIH///8A////AAAAAKQAAACrAAAAaP///wD///8AAAAARQAAANIAAADSAAAARf///wD///8AAAAAaAAAAKsAAACk////AAAAADMAAACcAAAAnQAAABj///8A////AP///wAAAAAYAAAAGP///wD///8A////AAAAABgAAACdAAAAnAAAADMAAAB1AAAAwwAAAP8AAADpAAAAsQAAAE4AAAAb////AP///wAAAAAbAAAATgAAALEAAADpAAAA/wAAAMMAAAB1AAAAtwAAAOkAAAD/AAAA/wAAAP8AAADvAAAA3gAAAN4AAADeAAAA3gAAAO8AAAD/AAAA/wAAAP8AAADpAAAAtwAAAGUAAAA/AAAA3wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAADfAAAAPwAAAGX///8A////AAAAAEgAAADtAAAAvwAAAL0AAADGAAAA7wAAAO8AAADGAAAAvQAAAL8AAADtAAAASP///wD///8A////AP///wD///8AAAAAO////wD///8A////AAAAAIcAAACH////AP///wD///8AAAAAO////wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A//8AAP//AAD4HwAA7/cAAN/7AAD//wAAoYUAAJ55AACf+QAAh+EAAAAAAADAAwAA4AcAAP5/AAD//wAA//8AAA=="/>
<link rel="icon" type="image/png" sizes="32x32" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAA3XAAAN1wFCKJt4AAAAB3RJTUUH4QQQEwksSS9ZWwAAAk1JREFUWMPtll2ITVEUx39nn/O7Y5qR8f05wtCUUr6ZIS++8pEnkZInPImneaCQ5METNdOkeFBKUhMPRIkHKfEuUZSUlGlKPN2TrgfncpvmnntnmlEyq1Z7t89/rf9a6+y99oZxGZf/XeIq61EdtgKXgdXA0xrYAvBjOIF1AI9zvjcC74BSpndrJPkBWDScTF8Aa4E3wDlgHbASaANmVqlcCnwHvgDvgVfAJ+AikAAvgfVZwLnSVZHZaOuKoQi3ZOMi4NkYkpe1p4J7A8BpYAD49hfIy/oqG0+hLomiKP2L5L+1ubn5115S+3OAn4EnwBlgMzCjyt6ZAnQCJ4A7wOs88iRJHvw50HoujuPBoCKwHWiosy8MdfZnAdcHk8dxXFJ3VQbQlCTJvRBCGdRbD4M6uc5glpY3eAihpN5S5w12diSEcCCEcKUO4ljdr15T76ur1FDDLIQQ3qv71EdDOe3Kxj3leRXyk+pxdWnFWod6Wt2bY3de3aSuUHcPBVimHs7mK9WrmeOF6lR1o9qnzskh2ar2qm1qizpfXaPeVGdlmGN5pb09qMxz1Xb1kLqgzn1RyH7JUXW52lr5e/Kqi9qpto7V1atuUzfnARrV7jEib1T76gG2qxdGmXyiekkt1GswPTtek0aBfJp6YySGBfWg2tPQ0FAYgf1stUfdmdcjarbYJEniKIq6gY/Aw+zWHAC+p2labGpqiorFYgGYCEzN7oQdQClN07O1/EfDyGgC0ALMBdYAi4FyK+4H3gLPsxfR1zRNi+NP7nH5J+QntnXe5B5mpfQAAAAASUVORK5CYII=">

<!-- CSS -->
<link rel="stylesheet" type="text/css" href="nimdoc.out.css?v=2.2.4">

<!-- JS -->
<script type="text/javascript" src="dochack.js?v=2.2.4"></script>
</head>
<body>
  <div class="document" id="documentId">
    <div class="container">
      <h1 class="title">simd_guide</h1>
      
<h1 id="simd-infrastructure">SIMD Infrastructure</h1><p>ReliQ's SIMD layer provides generic vector types and AoSoA memory layout computation for CPU-vectorized lattice traversal.  This infrastructure is used primarily by the OpenMP backend but is available to all backends.</p>

<h2 id="simd-vector-types">SIMD Vector Types</h2><p>The <tt class="docutils literal"><span class="pre">simd/simdtypes</span></tt> module provides <tt class="docutils literal"><span class="pre">SimdVec[N, T]</span></tt>, a generic SIMD vector wrapper that abstracts over different hardware SIMD widths.</p>

<h3 id="staticminuswidth-vectors">Static-Width Vectors</h3><p><pre class="listing"><span class="Keyword">import</span> <span class="Identifier">reliq</span>

<span class="Comment"># Generic construction</span>
<span class="Keyword">var</span> <span class="Identifier">v</span> <span class="Operator">=</span> <span class="Identifier">SimdVec</span><span class="Punctuation">[</span><span class="DecNumber">4</span><span class="Punctuation">,</span> <span class="Identifier">float64</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Punctuation">)</span>
<span class="Identifier">v</span><span class="Punctuation">[</span><span class="DecNumber">0</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="FloatNumber">1.0</span>
<span class="Identifier">v</span><span class="Punctuation">[</span><span class="DecNumber">1</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="FloatNumber">2.0</span>

<span class="Comment"># Broadcast</span>
<span class="Keyword">let</span> <span class="Identifier">ones</span> <span class="Operator">=</span> <span class="Identifier">splat</span><span class="Punctuation">[</span><span class="DecNumber">4</span><span class="Punctuation">,</span> <span class="Identifier">float64</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="FloatNumber">1.0</span><span class="Punctuation">)</span>    <span class="Comment"># [1.0, 1.0, 1.0, 1.0]</span>
<span class="Keyword">let</span> <span class="Identifier">z</span> <span class="Operator">=</span> <span class="Identifier">zero</span><span class="Punctuation">[</span><span class="DecNumber">4</span><span class="Punctuation">,</span> <span class="Identifier">float64</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Punctuation">)</span>           <span class="Comment"># [0.0, 0.0, 0.0, 0.0]</span></pre></p>

<h3 id="preminusdefined-type-aliases">Pre-Defined Type Aliases</h3><table border="1" class="docutils"><tr><th>Type</th><th>Width</th><th>Element</th><th>Hardware</th></tr>
<tr><td><tt class="docutils literal"><span class="pre">SimdF32x4</span></tt></td><td>4</td><td><tt class="docutils literal"><span class="pre">float32</span></tt></td><td>SSE</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">SimdF32x8</span></tt></td><td>8</td><td><tt class="docutils literal"><span class="pre">float32</span></tt></td><td>AVX2</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">SimdF32x16</span></tt></td><td>16</td><td><tt class="docutils literal"><span class="pre">float32</span></tt></td><td>AVX-512</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">SimdF64x2</span></tt></td><td>2</td><td><tt class="docutils literal"><span class="pre">float64</span></tt></td><td>SSE</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">SimdF64x4</span></tt></td><td>4</td><td><tt class="docutils literal"><span class="pre">float64</span></tt></td><td>AVX2</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">SimdF64x8</span></tt></td><td>8</td><td><tt class="docutils literal"><span class="pre">float64</span></tt></td><td>AVX-512</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">SimdI32x4/8/16</span></tt></td><td>4/8/16</td><td><tt class="docutils literal"><span class="pre">int32</span></tt></td><td>SSE/AVX2/AVX-512</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">SimdI64x2/4/8</span></tt></td><td>2/4/8</td><td><tt class="docutils literal"><span class="pre">int64</span></tt></td><td>SSE/AVX2/AVX-512</td></tr>
</table>
<h3 id="arithmetic-operations">Arithmetic Operations</h3><p><pre class="listing"><span class="Keyword">var</span> <span class="Identifier">a</span> <span class="Operator">=</span> <span class="Identifier">SimdF64x4</span><span class="Punctuation">(</span><span class="Identifier">data</span><span class="Punctuation">:</span> <span class="Punctuation">[</span><span class="FloatNumber">1.0</span><span class="Punctuation">,</span> <span class="FloatNumber">2.0</span><span class="Punctuation">,</span> <span class="FloatNumber">3.0</span><span class="Punctuation">,</span> <span class="FloatNumber">4.0</span><span class="Punctuation">]</span><span class="Punctuation">)</span>
<span class="Keyword">var</span> <span class="Identifier">b</span> <span class="Operator">=</span> <span class="Identifier">SimdF64x4</span><span class="Punctuation">(</span><span class="Identifier">data</span><span class="Punctuation">:</span> <span class="Punctuation">[</span><span class="FloatNumber">5.0</span><span class="Punctuation">,</span> <span class="FloatNumber">6.0</span><span class="Punctuation">,</span> <span class="FloatNumber">7.0</span><span class="Punctuation">,</span> <span class="FloatNumber">8.0</span><span class="Punctuation">]</span><span class="Punctuation">)</span>

<span class="Comment"># Element-wise operations</span>
<span class="Keyword">let</span> <span class="Identifier">c</span> <span class="Operator">=</span> <span class="Identifier">a</span> <span class="Operator">+</span> <span class="Identifier">b</span>        <span class="Comment"># [6.0, 8.0, 10.0, 12.0]</span>
<span class="Keyword">let</span> <span class="Identifier">d</span> <span class="Operator">=</span> <span class="Identifier">a</span> <span class="Operator">*</span> <span class="Identifier">b</span>        <span class="Comment"># [5.0, 12.0, 21.0, 32.0]</span>
<span class="Keyword">let</span> <span class="Identifier">e</span> <span class="Operator">=</span> <span class="Identifier">a</span> <span class="Operator">-</span> <span class="Identifier">b</span>        <span class="Comment"># [-4.0, -4.0, -4.0, -4.0]</span>
<span class="Keyword">let</span> <span class="Identifier">f</span> <span class="Operator">=</span> <span class="Identifier">a</span> <span class="Operator">/</span> <span class="Identifier">b</span>        <span class="Comment"># [0.2, 0.333..., 0.428..., 0.5]</span>

<span class="Comment"># Scalar operations</span>
<span class="Keyword">let</span> <span class="Identifier">g</span> <span class="Operator">=</span> <span class="FloatNumber">2.0</span> <span class="Operator">*</span> <span class="Identifier">a</span>      <span class="Comment"># [2.0, 4.0, 6.0, 8.0]</span>
<span class="Keyword">let</span> <span class="Identifier">h</span> <span class="Operator">=</span> <span class="Identifier">a</span> <span class="Operator">+</span> <span class="FloatNumber">1.0</span>      <span class="Comment"># [2.0, 3.0, 4.0, 5.0]</span>

<span class="Comment"># In-place operations</span>
<span class="Identifier">a</span> <span class="Operator">+=</span> <span class="Identifier">b</span>
<span class="Identifier">a</span> <span class="Operator">-=</span> <span class="Identifier">b</span>
<span class="Identifier">a</span> <span class="Operator">*=</span> <span class="FloatNumber">2.0</span>

<span class="Comment"># Reductions</span>
<span class="Keyword">let</span> <span class="Identifier">s</span> <span class="Operator">=</span> <span class="Identifier">a</span><span class="Operator">.</span><span class="Identifier">sum</span><span class="Punctuation">(</span><span class="Punctuation">)</span>      <span class="Comment"># 10.0</span>
<span class="Keyword">let</span> <span class="Identifier">p</span> <span class="Operator">=</span> <span class="Identifier">a</span><span class="Operator">.</span><span class="Identifier">product</span><span class="Punctuation">(</span><span class="Punctuation">)</span>  <span class="Comment"># 24.0</span>
<span class="Keyword">let</span> <span class="Identifier">mn</span> <span class="Operator">=</span> <span class="Identifier">a</span><span class="Operator">.</span><span class="Identifier">min</span><span class="Punctuation">(</span><span class="Punctuation">)</span>     <span class="Comment"># 1.0</span>
<span class="Keyword">let</span> <span class="Identifier">mx</span> <span class="Operator">=</span> <span class="Identifier">a</span><span class="Operator">.</span><span class="Identifier">max</span><span class="Punctuation">(</span><span class="Punctuation">)</span>     <span class="Comment"># 4.0</span></pre></p>

<h3 id="memory-operations">Memory Operations</h3><p><pre class="listing"><span class="Keyword">var</span> <span class="Identifier">buf</span><span class="Punctuation">:</span> <span class="Identifier">array</span><span class="Punctuation">[</span><span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="Identifier">float64</span><span class="Punctuation">]</span>

<span class="Comment"># Load from contiguous memory</span>
<span class="Keyword">let</span> <span class="Identifier">v</span> <span class="Operator">=</span> <span class="Identifier">load</span><span class="Punctuation">[</span><span class="DecNumber">4</span><span class="Punctuation">,</span> <span class="Identifier">float64</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Keyword">addr</span> <span class="Identifier">buf</span><span class="Punctuation">[</span><span class="DecNumber">0</span><span class="Punctuation">]</span><span class="Punctuation">)</span>

<span class="Comment"># Store to contiguous memory</span>
<span class="Identifier">store</span><span class="Punctuation">(</span><span class="Identifier">v</span><span class="Punctuation">,</span> <span class="Keyword">addr</span> <span class="Identifier">buf</span><span class="Punctuation">[</span><span class="DecNumber">0</span><span class="Punctuation">]</span><span class="Punctuation">)</span>

<span class="Comment"># Strided load/store (e.g., for gather/scatter)</span>
<span class="Keyword">let</span> <span class="Identifier">vs</span> <span class="Operator">=</span> <span class="Identifier">loadStrided</span><span class="Punctuation">[</span><span class="DecNumber">4</span><span class="Punctuation">,</span> <span class="Identifier">float64</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Keyword">addr</span> <span class="Identifier">buf</span><span class="Punctuation">[</span><span class="DecNumber">0</span><span class="Punctuation">]</span><span class="Punctuation">,</span> <span class="Identifier">stride</span><span class="Operator">=</span><span class="DecNumber">2</span><span class="Punctuation">)</span>
<span class="Identifier">storeStrided</span><span class="Punctuation">(</span><span class="Identifier">vs</span><span class="Punctuation">,</span> <span class="Keyword">addr</span> <span class="Identifier">buf</span><span class="Punctuation">[</span><span class="DecNumber">0</span><span class="Punctuation">]</span><span class="Punctuation">,</span> <span class="Identifier">stride</span><span class="Operator">=</span><span class="DecNumber">2</span><span class="Punctuation">)</span></pre></p>

<h3 id="hardware-intrinsics">Hardware Intrinsics</h3><p>When compiled with <tt class="docutils literal"><span class="pre">-d:AVX2</span></tt> or <tt class="docutils literal"><span class="pre">-d:AVX512</span></tt>, the generic loop-based implementations are replaced with hardware-specific intrinsics:</p>
<table border="1" class="docutils"><tr><th>Compile flag</th><th>Procs accelerated</th><th>Instructions</th></tr>
<tr><td><tt class="docutils literal"><span class="pre">-d:AVX2</span></tt></td><td><tt class="docutils literal"><span class="pre">SimdF32x8</span></tt>, <tt class="docutils literal"><span class="pre">SimdF64x4</span></tt> add/sub/mul/madd</td><td><tt class="docutils literal"><span class="pre">_mm256_*</span></tt></td></tr>
<tr><td><tt class="docutils literal"><span class="pre">-d:AVX512</span></tt></td><td><tt class="docutils literal"><span class="pre">SimdF32x16</span></tt>, <tt class="docutils literal"><span class="pre">SimdF64x8</span></tt> add/sub/mul/madd</td><td><tt class="docutils literal"><span class="pre">_mm512_*</span></tt></td></tr>
</table><p>The <tt class="docutils literal"><span class="pre">madd</span></tt> (fused multiply-add) proc computes <tt class="docutils literal"><span class="pre">a * b + c</span></tt> in a single instruction when available.</p>

<h3 id="dynamicminuswidth-vectors">Dynamic-Width Vectors</h3><p><tt class="docutils literal"><span class="pre">SimdVecDyn[T]</span></tt> supports runtime-configurable SIMD width:</p>
<p><pre class="listing"><span class="Keyword">let</span> <span class="Identifier">dyn</span> <span class="Operator">=</span> <span class="Identifier">newSimdVecDyn</span><span class="Punctuation">[</span><span class="Identifier">float64</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="DecNumber">4</span><span class="Punctuation">,</span> <span class="FloatNumber">1.0</span><span class="Punctuation">)</span>  <span class="Comment"># 4 lanes, filled with 1.0</span>
<span class="Identifier">echo</span> <span class="Identifier">dyn</span><span class="Operator">.</span><span class="Identifier">width</span>  <span class="Comment"># 4</span>
<span class="Keyword">let</span> <span class="Identifier">sum</span> <span class="Operator">=</span> <span class="Identifier">dyn</span><span class="Operator">.</span><span class="Identifier">sum</span><span class="Punctuation">(</span><span class="Punctuation">)</span>  <span class="Comment"># 4.0</span></pre></p>

<h2 id="simd-lattice-layout">SIMD Lattice Layout</h2><p>The <tt class="docutils literal"><span class="pre">simd/simdlayout</span></tt> module computes AoSoA memory layouts for SIMD-vectorized lattice traversal.</p>

<h3 id="key-concepts">Key Concepts</h3><p>The layout splits each lattice dimension into:</p>
<ul class="simple"><li><strong>innerGeom</strong> — Sites within a SIMD group (lane indices)</li>
<li><strong>outerGeom</strong> — SIMD groups (outer loop indices)</li>
</ul>
<p><pre class="listing">localGeom = [8, 8, 8, 16]
simdGrid  = [1, 1, 1, 8]     ← 8 lanes along t-axis
innerGeom = [1, 1, 1, 8]     ← each SIMD group is 8 sites in t
outerGeom = [8, 8, 8, 2]     ← 2 outer groups in t (16/8)</pre></p>

<h3 id="construction">Construction</h3><p><pre class="listing"><span class="Keyword">import</span> <span class="Identifier">reliq</span>

<span class="Comment"># Explicit SIMD grid</span>
<span class="Keyword">let</span> <span class="Identifier">layout</span> <span class="Operator">=</span> <span class="Identifier">newSimdLatticeLayout</span><span class="Punctuation">(</span><span class="Punctuation">[</span><span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">16</span><span class="Punctuation">]</span><span class="Punctuation">,</span> <span class="Punctuation">[</span><span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">8</span><span class="Punctuation">]</span><span class="Punctuation">)</span>

<span class="Comment"># Auto-distributed (fills fastest-varying dims first)</span>
<span class="Keyword">let</span> <span class="Identifier">layout2</span> <span class="Operator">=</span> <span class="Identifier">newSimdLatticeLayout</span><span class="Punctuation">(</span><span class="Punctuation">[</span><span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">16</span><span class="Punctuation">]</span><span class="Punctuation">,</span> <span class="Identifier">simdWidth</span><span class="Operator">=</span><span class="DecNumber">8</span><span class="Punctuation">)</span></pre></p>

<h3 id="properties">Properties</h3><table border="1" class="docutils"><tr><th>Property</th><th>Description</th></tr>
<tr><td><tt class="docutils literal"><span class="pre">nSitesInner</span></tt></td><td>Sites per SIMD group (= product of innerGeom)</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">nSitesOuter</span></tt></td><td>Number of SIMD groups</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">nSites</span></tt></td><td>Total local sites</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">simdLanes(layout)</span></tt></td><td>Alias for <tt class="docutils literal"><span class="pre">nSitesInner</span></tt></td></tr>
<tr><td><tt class="docutils literal"><span class="pre">vectorGroups(layout)</span></tt></td><td>Alias for <tt class="docutils literal"><span class="pre">nSitesOuter</span></tt></td></tr>
</table>
<h3 id="index-conversions">Index Conversions</h3><p><pre class="listing"><span class="Comment"># Local site ↔ (outer, inner)</span>
<span class="Keyword">let</span> <span class="Punctuation">(</span><span class="Identifier">outer</span><span class="Punctuation">,</span> <span class="Identifier">inner</span><span class="Punctuation">)</span> <span class="Operator">=</span> <span class="Identifier">localToOuterInner</span><span class="Punctuation">(</span><span class="Identifier">localIdx</span><span class="Punctuation">,</span> <span class="Identifier">layout</span><span class="Punctuation">)</span>
<span class="Keyword">let</span> <span class="Identifier">local</span> <span class="Operator">=</span> <span class="Identifier">outerInnerToLocal</span><span class="Punctuation">(</span><span class="Identifier">outer</span><span class="Punctuation">,</span> <span class="Identifier">inner</span><span class="Punctuation">,</span> <span class="Identifier">layout</span><span class="Punctuation">)</span>

<span class="Comment"># AoSoA index (for data buffers)</span>
<span class="Keyword">let</span> <span class="Identifier">idx</span> <span class="Operator">=</span> <span class="Identifier">aosoaIndex</span><span class="Punctuation">(</span><span class="Identifier">outer</span><span class="Punctuation">,</span> <span class="Identifier">inner</span><span class="Punctuation">,</span> <span class="Identifier">elemIdx</span><span class="Punctuation">,</span> <span class="Identifier">elemsPerSite</span><span class="Punctuation">,</span> <span class="Identifier">nSitesInner</span><span class="Punctuation">)</span>

<span class="Comment"># Coordinate lookup table</span>
<span class="Keyword">let</span> <span class="Identifier">table</span> <span class="Operator">=</span> <span class="Identifier">generateCoordTable</span><span class="Punctuation">(</span><span class="Identifier">layout</span><span class="Punctuation">)</span>
<span class="Comment"># table[outer][lane] → local site index</span></pre></p>

<h3 id="aosoa-index-formula">AoSoA Index Formula</h3><p>For a site at <tt class="docutils literal"><span class="pre">(outerIdx, innerIdx)</span></tt> with element <tt class="docutils literal"><span class="pre">elemIdx</span></tt>:</p>
<p>$$text{index} = text{outerIdx} times (text{elemsPerSite} times text{nSitesInner}) + text{elemIdx} times text{nSitesInner} + text{innerIdx}$$</p>
<p>This layout ensures that consecutive SIMD lanes access consecutive memory addresses for the same element — optimal for SIMD <tt class="docutils literal"><span class="pre">load</span></tt>/<tt class="docutils literal"><span class="pre">store</span></tt> instructions.</p>

<h3 id="validation">Validation</h3><p><pre class="listing"><span class="Keyword">let</span> <span class="Punctuation">(</span><span class="Identifier">valid</span><span class="Punctuation">,</span> <span class="Identifier">msg</span><span class="Punctuation">)</span> <span class="Operator">=</span> <span class="Identifier">validateSimdGrid</span><span class="Punctuation">(</span><span class="Punctuation">[</span><span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">16</span><span class="Punctuation">]</span><span class="Punctuation">,</span> <span class="Punctuation">[</span><span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">4</span><span class="Punctuation">]</span><span class="Punctuation">,</span> <span class="Punctuation">[</span><span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">8</span><span class="Punctuation">]</span><span class="Punctuation">)</span>
<span class="Keyword">if</span> <span class="Keyword">not</span> <span class="Identifier">valid</span><span class="Punctuation">:</span>
  <span class="Identifier">echo</span> <span class="Identifier">msg</span>  <span class="Comment"># Error: SIMD grid exceeds local geometry</span></pre></p>

<h2 id="module-reference">Module Reference</h2><table border="1" class="docutils"><tr><th>Module</th><th>Description</th></tr>
<tr><td><a class="reference external" href="simd/simdtypes.html">simd/simdtypes</a></td><td><tt class="docutils literal"><span class="pre">SimdVec[N,T]</span></tt> and hardware intrinsic wrappers</td></tr>
<tr><td><a class="reference external" href="simd/simdlayout.html">simd/simdlayout</a></td><td><tt class="docutils literal"><span class="pre">SimdLatticeLayout</span></tt> and AoSoA index computation</td></tr>
</table>


      <div class="twelve-columns footer">
        <span class="nim-sprite"></span>
        <br>
        <small style="color: var(--hint);">Made with Nim. Generated: 2026-02-07 06:49:56 UTC</small>
      </div>
    </div>
  </div>
  
</body>
</html>

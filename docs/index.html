<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--  This file is generated by Nim. -->
<html xmlns="https://www.w3.org/1999/xhtml" xml:lang="en" lang="en" data-theme="auto">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>index</title>

<!-- Google fonts -->
<link href='https://fonts.googleapis.com/css?family=Lato:400,600,900' rel='stylesheet' type='text/css'/>
<link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,500,600' rel='stylesheet' type='text/css'/>

<!-- Favicon -->
<link rel="shortcut icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAUAAAAF////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAIAAABbAAAAlQAAAKIAAACbAAAAmwAAAKIAAACVAAAAWwAAAAL///8A////AP///wD///8A////AAAAABQAAADAAAAAYwAAAA3///8A////AP///wD///8AAAAADQAAAGMAAADAAAAAFP///wD///8A////AP///wAAAACdAAAAOv///wD///8A////AP///wD///8A////AP///wD///8AAAAAOgAAAJ3///8A////AP///wAAAAAnAAAAcP///wAAAAAoAAAASv///wD///8A////AP///wAAAABKAAAAKP///wAAAABwAAAAJ////wD///8AAAAAgQAAABwAAACIAAAAkAAAAJMAAACtAAAAFQAAABUAAACtAAAAkwAAAJAAAACIAAAAHAAAAIH///8A////AAAAAKQAAACrAAAAaP///wD///8AAAAARQAAANIAAADSAAAARf///wD///8AAAAAaAAAAKsAAACk////AAAAADMAAACcAAAAnQAAABj///8A////AP///wAAAAAYAAAAGP///wD///8A////AAAAABgAAACdAAAAnAAAADMAAAB1AAAAwwAAAP8AAADpAAAAsQAAAE4AAAAb////AP///wAAAAAbAAAATgAAALEAAADpAAAA/wAAAMMAAAB1AAAAtwAAAOkAAAD/AAAA/wAAAP8AAADvAAAA3gAAAN4AAADeAAAA3gAAAO8AAAD/AAAA/wAAAP8AAADpAAAAtwAAAGUAAAA/AAAA3wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAADfAAAAPwAAAGX///8A////AAAAAEgAAADtAAAAvwAAAL0AAADGAAAA7wAAAO8AAADGAAAAvQAAAL8AAADtAAAASP///wD///8A////AP///wD///8AAAAAO////wD///8A////AAAAAIcAAACH////AP///wD///8AAAAAO////wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A//8AAP//AAD4HwAA7/cAAN/7AAD//wAAoYUAAJ55AACf+QAAh+EAAAAAAADAAwAA4AcAAP5/AAD//wAA//8AAA=="/>
<link rel="icon" type="image/png" sizes="32x32" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAA3XAAAN1wFCKJt4AAAAB3RJTUUH4QQQEwksSS9ZWwAAAk1JREFUWMPtll2ITVEUx39nn/O7Y5qR8f05wtCUUr6ZIS++8pEnkZInPImneaCQ5METNdOkeFBKUhMPRIkHKfEuUZSUlGlKPN2TrgfncpvmnntnmlEyq1Z7t89/rf9a6+y99oZxGZf/XeIq61EdtgKXgdXA0xrYAvBjOIF1AI9zvjcC74BSpndrJPkBWDScTF8Aa4E3wDlgHbASaANmVqlcCnwHvgDvgVfAJ+AikAAvgfVZwLnSVZHZaOuKoQi3ZOMi4NkYkpe1p4J7A8BpYAD49hfIy/oqG0+hLomiKP2L5L+1ubn5115S+3OAn4EnwBlgMzCjyt6ZAnQCJ4A7wOs88iRJHvw50HoujuPBoCKwHWiosy8MdfZnAdcHk8dxXFJ3VQbQlCTJvRBCGdRbD4M6uc5glpY3eAihpN5S5w12diSEcCCEcKUO4ljdr15T76ur1FDDLIQQ3qv71EdDOe3Kxj3leRXyk+pxdWnFWod6Wt2bY3de3aSuUHcPBVimHs7mK9WrmeOF6lR1o9qnzskh2ar2qm1qizpfXaPeVGdlmGN5pb09qMxz1Xb1kLqgzn1RyH7JUXW52lr5e/Kqi9qpto7V1atuUzfnARrV7jEib1T76gG2qxdGmXyiekkt1GswPTtek0aBfJp6YySGBfWg2tPQ0FAYgf1stUfdmdcjarbYJEniKIq6gY/Aw+zWHAC+p2labGpqiorFYgGYCEzN7oQdQClN07O1/EfDyGgC0ALMBdYAi4FyK+4H3gLPsxfR1zRNi+NP7nH5J+QntnXe5B5mpfQAAAAASUVORK5CYII=">

<!-- CSS -->
<link rel="stylesheet" type="text/css" href="nimdoc.out.css?v=2.2.4">

<!-- JS -->
<script type="text/javascript" src="dochack.js?v=2.2.4"></script>
</head>
<body>
  <div class="document" id="documentId">
    <div class="container">
      <h1 class="title">index</h1>
      
<h1 id="reliq-lattice-field-theory-framework">ReliQ Lattice Field Theory Framework</h1><blockquote class="markdown-quote"><p><em>&quot;Documentation is a love letter that you write to your future self.&quot;</em> — Damian Conway</p></blockquote>

<h2 id="overview">Overview</h2><p><strong>ReliQ</strong> is an experimental lattice field theory (LFT) framework written in <a class="reference external" href="https://nim-lang.org/">Nim</a>, designed for user-friendliness, performance, reliability, and portability across current and future heterogeneous architectures.</p>

<h3 id="key-features">Key Features</h3><ul class="simple"><li><strong>Multi-backend dispatch</strong>: OpenCL (GPU JIT), SYCL (pre-compiled GPU/CPU), OpenMP (SIMD-vectorized CPU) — all sharing the same user-facing API</li>
<li><strong>AoSoA memory layout</strong>: Array of Structures of Arrays for optimal SIMD and GPU memory coalescing</li>
<li><strong>Distributed memory</strong>: MPI-based parallelism via <a class="reference external" href="https://globalarrays.github.io/">Global Arrays</a> with automatic ghost region management</li>
<li><strong>Compile-time tensor types</strong>: <tt class="docutils literal"><span class="pre">Vec[N,T]</span></tt> and <tt class="docutils literal"><span class="pre">Mat[N,M,T]</span></tt> with dimensions known at compile time for zero-overhead abstraction</li>
<li><strong>Unified stencil operations</strong>: A single <tt class="docutils literal"><span class="pre">LatticeStencil[D]</span></tt> type that works identically across all backends, handling periodic boundary conditions and ghost regions automatically</li>
<li><strong>Macro-based dispatch</strong>: The <tt class="docutils literal"><span class="pre">each</span></tt> macro analyzes loop bodies at compile time and generates optimized backend-specific code</li>
</ul>

<h2 id="quick-start">Quick Start</h2><p><pre class="listing"><span class="Keyword">import</span> <span class="Identifier">reliq</span>

<span class="Comment"># Create a 4D lattice (8×8×8×16)</span>
<span class="Keyword">let</span> <span class="Identifier">lat</span> <span class="Operator">=</span> <span class="Identifier">newSimpleCubicLattice</span><span class="Punctuation">(</span><span class="Punctuation">[</span><span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">16</span><span class="Punctuation">]</span><span class="Punctuation">)</span>

<span class="Comment"># Create a scalar field on the lattice</span>
<span class="Keyword">var</span> <span class="Identifier">phi</span> <span class="Operator">=</span> <span class="Identifier">newTensorField</span><span class="Punctuation">[</span><span class="DecNumber">4</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="Identifier">float64</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Identifier">lat</span><span class="Punctuation">)</span>
<span class="Keyword">var</span> <span class="Identifier">psi</span> <span class="Operator">=</span> <span class="Identifier">newTensorField</span><span class="Punctuation">[</span><span class="DecNumber">4</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="Identifier">float64</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Identifier">lat</span><span class="Punctuation">)</span>

<span class="Comment"># Create views for GPU/SIMD dispatch</span>
<span class="Keyword">var</span> <span class="Identifier">vPhi</span> <span class="Operator">=</span> <span class="Identifier">newTensorFieldView</span><span class="Punctuation">(</span><span class="Identifier">phi</span><span class="Punctuation">)</span>
<span class="Keyword">var</span> <span class="Identifier">vPsi</span> <span class="Operator">=</span> <span class="Identifier">newTensorFieldView</span><span class="Punctuation">(</span><span class="Identifier">psi</span><span class="Punctuation">)</span>

<span class="Comment"># Initialize psi to 1.0 on all sites</span>
<span class="Identifier">each</span> <span class="Identifier">vPsi</span><span class="Punctuation">,</span> <span class="Identifier">n</span><span class="Punctuation">:</span>
  <span class="Identifier">vPsi</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="FloatNumber">1.0</span>

<span class="Comment"># Nearest-neighbor stencil for computing Laplacian</span>
<span class="Keyword">let</span> <span class="Identifier">stencil</span> <span class="Operator">=</span> <span class="Identifier">newLatticeStencil</span><span class="Punctuation">(</span><span class="Identifier">nearestNeighborStencil</span><span class="Punctuation">(</span><span class="Identifier">lat</span><span class="Punctuation">)</span><span class="Punctuation">,</span> <span class="Identifier">lat</span><span class="Punctuation">)</span>

<span class="Comment"># Access neighbor data in each loops</span>
<span class="Identifier">each</span> <span class="Identifier">vPhi</span><span class="Punctuation">,</span> <span class="Identifier">vPsi</span><span class="Punctuation">,</span> <span class="Identifier">stencil</span><span class="Punctuation">,</span> <span class="Identifier">n</span><span class="Punctuation">:</span>
  <span class="Keyword">let</span> <span class="Identifier">nbrIdx</span> <span class="Operator">=</span> <span class="Identifier">stencil</span><span class="Operator">.</span><span class="Identifier">neighbor</span><span class="Punctuation">(</span><span class="Identifier">n</span><span class="Punctuation">,</span> <span class="DecNumber">0</span><span class="Punctuation">)</span>  <span class="Comment"># Forward x-neighbor</span>
  <span class="Identifier">vPhi</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="Identifier">vPsi</span><span class="Punctuation">[</span><span class="Identifier">nbrIdx</span><span class="Punctuation">]</span></pre></p>

<h2 id="architecture">Architecture</h2><p>ReliQ is organized into several layers:</p>
<p><pre class="listing">┌──────────────────────────────────────────────┐
│                User Code                     │
│          import reliq; each v, n: ...        │
├──────────────────────────────────────────────┤
│             Tensor Layer                     │
│  TensorFieldView · Stencil · Transporter     │
├──────────────────────────────────────────────┤
│           Backend Dispatch                   │
│    OpenCL    │    SYCL    │    OpenMP         │
│   (cldisp)   │  (sycldisp) │  (ompdisp)      │
├──────────────────────────────────────────────┤
│         Memory &amp; Communication               │
│   Global Arrays · MPI · AoSoA Layout         │
└──────────────────────────────────────────────┘</pre></p>

<h2 id="module-reference">Module Reference</h2>
<h3 id="core-modules">Core Modules</h3><ul class="simple"><li><a class="reference external" href="reliq.html">reliq</a> — Top-level entry point; re-exports all public modules</li>
<li><a class="reference external" href="lattice.html">lattice</a> — Lattice types and concepts</li>
<li><a class="reference external" href="parallel.html">parallel</a> — Backend-agnostic parallel dispatch</li>
</ul>

<h3 id="lattice">Lattice</h3><ul class="simple"><li><a class="reference external" href="lattice/latticeconcept.html">lattice/latticeconcept</a> — The <tt class="docutils literal"><span class="pre">Lattice[D]</span></tt> concept that all lattice types must satisfy</li>
<li><a class="reference external" href="lattice/simplecubiclattice.html">lattice/simplecubiclattice</a> — <tt class="docutils literal"><span class="pre">SimpleCubicLattice[D]</span></tt> implementation with MPI decomposition</li>
<li><a class="reference external" href="lattice/stencil.html">lattice/stencil</a> — Unified stencil operations: <tt class="docutils literal"><span class="pre">LatticeStencil[D]</span></tt>, <tt class="docutils literal"><span class="pre">StencilPattern[D]</span></tt>, neighbor access, shift API, direction types</li>
<li><a class="reference external" href="lattice/indexing.html">lattice/indexing</a> — Coordinate ↔ flat index conversion utilities</li>
</ul>

<h3 id="tensor-fields">Tensor Fields</h3><ul class="simple"><li><a class="reference external" href="tensor/tensor.html">tensor/tensor</a> — Tensor module aggregation</li>
<li><a class="reference external" href="tensor/tensorview.html">tensor/tensorview</a> — <tt class="docutils literal"><span class="pre">TensorFieldView[L,T]</span></tt>: the primary type for GPU/SIMD dispatch via the <tt class="docutils literal"><span class="pre">each</span></tt> macro</li>
<li><a class="reference external" href="tensor/globaltensor.html">tensor/globaltensor</a> — <tt class="docutils literal"><span class="pre">TensorField[D,R,L,T]</span></tt>: distributed tensor field with ghost region support</li>
<li><a class="reference external" href="tensor/localtensor.html">tensor/localtensor</a> — <tt class="docutils literal"><span class="pre">LocalTensorField[D,R,L,T]</span></tt>: rank-local tensor data in host memory</li>
<li><a class="reference external" href="tensor/sitetensor.html">tensor/sitetensor</a> — <tt class="docutils literal"><span class="pre">Vec[N,T]</span></tt> and <tt class="docutils literal"><span class="pre">Mat[N,M,T]</span></tt>: compile-time dimensioned site-level tensor types</li>
<li><a class="reference external" href="tensor/transporter.html">tensor/transporter</a> — <tt class="docutils literal"><span class="pre">Shifter[D,T]</span></tt> and <tt class="docutils literal"><span class="pre">Transporter[D,U,F]</span></tt>: parallel transport with MPI halo exchange</li>
</ul>

<h3 id="backendcolon-opencl">Backend: OpenCL</h3><ul class="simple"><li><a class="reference external" href="opencl/cldisp.html">opencl/cldisp</a> — <tt class="docutils literal"><span class="pre">each</span></tt> macro: compile-time expression analysis → OpenCL kernel generation (JIT)</li>
<li><a class="reference external" href="opencl/clbase.html">opencl/clbase</a> — OpenCL platform/device/buffer management and math intrinsics</li>
</ul>

<h3 id="backendcolon-sycl">Backend: SYCL</h3><ul class="simple"><li><a class="reference external" href="sycl/sycldisp.html">sycl/sycldisp</a> — <tt class="docutils literal"><span class="pre">each</span></tt> macro: compile-time expression analysis → pre-compiled C++ SYCL kernel dispatch</li>
<li><a class="reference external" href="sycl/syclbase.html">sycl/syclbase</a> — SYCL queue/buffer management</li>
<li><a class="reference external" href="sycl/syclwrap.html">sycl/syclwrap</a> — Low-level FFI bindings to <tt class="docutils literal"><span class="pre">libreliq_sycl.so</span></tt></li>
</ul>

<h3 id="backendcolon-openmp">Backend: OpenMP</h3><ul class="simple"><li><a class="reference external" href="openmp/ompdisp.html">openmp/ompdisp</a> — <tt class="docutils literal"><span class="pre">each</span></tt> macro: compile-time expression analysis → SIMD-vectorized OpenMP code generation</li>
<li><a class="reference external" href="openmp/ompbase.html">openmp/ompbase</a> — OpenMP initialization and thread management</li>
<li><a class="reference external" href="openmp/ompsimd.html">openmp/ompsimd</a> — SIMD-aware dispatch with outer/inner loop pattern</li>
</ul>

<h3 id="simd-infrastructure">SIMD Infrastructure</h3><ul class="simple"><li><a class="reference external" href="simd/simdtypes.html">simd/simdtypes</a> — <tt class="docutils literal"><span class="pre">SimdVec[N,T]</span></tt> and <tt class="docutils literal"><span class="pre">SimdVecDyn[T]</span></tt>: generic SIMD vector types abstracting SSE/AVX2/AVX-512</li>
<li><a class="reference external" href="simd/simdlayout.html">simd/simdlayout</a> — <tt class="docutils literal"><span class="pre">SimdLatticeLayout</span></tt>: AoSoA memory layout computation for SIMD-vectorized lattice traversal</li>
</ul>

<h3 id="distributed-memory">Distributed Memory</h3><ul class="simple"><li><a class="reference external" href="globalarrays/gatypes.html">globalarrays/gatypes</a> — <tt class="docutils literal"><span class="pre">GlobalArray[D,T]</span></tt>: distributed array with ghost regions via Global Arrays</li>
<li><a class="reference external" href="globalarrays/gabase.html">globalarrays/gabase</a> — Global Arrays initialization and finalization</li>
<li><a class="reference external" href="globalarrays/gawrap.html">globalarrays/gawrap</a> — Low-level C FFI bindings to the Global Arrays library</li>
<li><a class="reference external" href="globalarrays/gampi.html">globalarrays/gampi</a> — MPI initialization and communication primitives</li>
</ul>

<h3 id="islasho">I/O</h3><ul class="simple"><li><a class="reference external" href="io/io.html">io/io</a> — Unified I/O for lattice data: LIME containers, SciDAC format with XML metadata, ILDG gauge configurations, QIO parallel I/O</li>
</ul>

<h3 id="utilities">Utilities</h3><ul class="simple"><li><a class="reference external" href="utils/complex.html">utils/complex</a> — Complex number type predicates</li>
<li><a class="reference external" href="utils/private.html">utils/private</a> — Internal utility functions</li>
</ul>

<h2 id="backend-selection">Backend Selection</h2><p>ReliQ supports three compute backends, selected at compile time:</p>
<table border="1" class="docutils"><tr><th>Backend</th><th>Flag</th><th>Requirements</th><th>Best For</th></tr>
<tr><td>OpenCL</td><td><em>(default)</em></td><td>OpenCL runtime (pocl, vendor SDK)</td><td>GPUs, FPGAs</td></tr>
<tr><td>SYCL</td><td><tt class="docutils literal"><span class="pre">BACKEND=sycl</span></tt></td><td>Intel oneAPI (icpx) or hipSYCL</td><td>Intel GPUs, modern CPUs</td></tr>
<tr><td>OpenMP</td><td><tt class="docutils literal"><span class="pre">BACKEND=openmp</span></tt></td><td>GCC/Clang with OpenMP</td><td>CPU-only, SIMD vectorization</td></tr>
</table>
<h3 id="building">Building</h3><p><pre class="listing"># OpenCL (default)
make tensorview

# OpenMP
make tensorview BACKEND=openmp

# SYCL (requires building the wrapper library first)
make sycl-lib
make tensorview BACKEND=sycl</pre></p>

<h3 id="running-tests">Running Tests</h3><p><pre class="listing"># Run all tests across all backends
make test

# Run tests for a specific backend
make test-core       # Backend-agnostic core tests
make test-opencl     # OpenCL backend tests
make test-openmp     # OpenMP backend tests
make test-sycl       # SYCL backend tests</pre></p>

<h2 id="the-each-macro">The <tt class="docutils literal"><span class="pre">each</span></tt> Macro</h2><p>The <tt class="docutils literal"><span class="pre">each</span></tt> macro is the primary mechanism for expressing computations on lattice fields. It analyzes the loop body at compile time and generates optimized backend-specific code.</p>

<h3 id="supported-patterns">Supported Patterns</h3><p><pre class="listing"><span class="Comment"># Vector/scalar copy</span>
<span class="Identifier">each</span> <span class="Identifier">vDst</span><span class="Punctuation">,</span> <span class="Identifier">vSrc</span><span class="Punctuation">,</span> <span class="Identifier">n</span><span class="Punctuation">:</span>
  <span class="Identifier">vDst</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="Identifier">vSrc</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span>

<span class="Comment"># Scalar multiplication</span>
<span class="Identifier">each</span> <span class="Identifier">vDst</span><span class="Punctuation">,</span> <span class="Identifier">vSrc</span><span class="Punctuation">,</span> <span class="Identifier">n</span><span class="Punctuation">:</span>
  <span class="Identifier">vDst</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="FloatNumber">3.0</span> <span class="Operator">*</span> <span class="Identifier">vSrc</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span>

<span class="Comment"># Matrix multiplication</span>
<span class="Identifier">each</span> <span class="Identifier">vDst</span><span class="Punctuation">,</span> <span class="Identifier">vA</span><span class="Punctuation">,</span> <span class="Identifier">vB</span><span class="Punctuation">,</span> <span class="Identifier">n</span><span class="Punctuation">:</span>
  <span class="Identifier">vDst</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="Identifier">vA</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span> <span class="Operator">*</span> <span class="Identifier">vB</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span>

<span class="Comment"># Matrix-vector multiplication</span>
<span class="Identifier">each</span> <span class="Identifier">vDst</span><span class="Punctuation">,</span> <span class="Identifier">vA</span><span class="Punctuation">,</span> <span class="Identifier">vB</span><span class="Punctuation">,</span> <span class="Identifier">n</span><span class="Punctuation">:</span>
  <span class="Identifier">vDst</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="Identifier">vA</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span> <span class="Operator">*</span> <span class="Identifier">vB</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span>  <span class="Comment"># Mat * Vec</span>

<span class="Comment"># Addition / subtraction</span>
<span class="Identifier">each</span> <span class="Identifier">vDst</span><span class="Punctuation">,</span> <span class="Identifier">vA</span><span class="Punctuation">,</span> <span class="Identifier">vB</span><span class="Punctuation">,</span> <span class="Identifier">n</span><span class="Punctuation">:</span>
  <span class="Identifier">vDst</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="Identifier">vA</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span> <span class="Operator">+</span> <span class="Identifier">vB</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span>

<span class="Comment"># Stencil neighbor access</span>
<span class="Identifier">each</span> <span class="Identifier">vDst</span><span class="Punctuation">,</span> <span class="Identifier">vSrc</span><span class="Punctuation">,</span> <span class="Identifier">stencil</span><span class="Punctuation">,</span> <span class="Identifier">n</span><span class="Punctuation">:</span>
  <span class="Keyword">let</span> <span class="Identifier">nbrIdx</span> <span class="Operator">=</span> <span class="Identifier">stencil</span><span class="Operator">.</span><span class="Identifier">neighbor</span><span class="Punctuation">(</span><span class="Identifier">n</span><span class="Punctuation">,</span> <span class="DecNumber">0</span><span class="Punctuation">)</span>
  <span class="Identifier">vDst</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="Identifier">vSrc</span><span class="Punctuation">[</span><span class="Identifier">nbrIdx</span><span class="Punctuation">]</span></pre></p>

<h3 id="what-happens-under-the-hood">What Happens Under the Hood</h3><ol class="simple"><li><strong>Parse</strong>: The macro receives the loop body as an AST</li>
<li><strong>Analyze</strong>: Expression trees are classified (copy, add, matmul, etc.)</li>
<li><strong>Detect stencils</strong>: <tt class="docutils literal"><span class="pre">let nbrIdx = stencil.neighbor(n, k)</span></tt> patterns are detected and tracked</li>
<li><strong>Generate</strong>: Backend-specific code is emitted:<ul class="simple"><li><strong>OpenCL</strong>: An OpenCL C kernel string is generated, compiled via JIT, and dispatched with <tt class="docutils literal"><span class="pre">clEnqueueNDRangeKernel</span></tt></li>
<li><strong>SYCL</strong>: Calls to pre-compiled C++ template kernels in <tt class="docutils literal"><span class="pre">libreliq_sycl.so</span></tt> are emitted</li>
<li><strong>OpenMP</strong>: SIMD-vectorized C code with <tt class="docutils literal"><span class="pre">#pragma omp parallel for</span></tt> and explicit SIMD intrinsic calls is generated</li>
</ul>
</li>
</ol>

<h2 id="aosoa-memory-layout">AoSoA Memory Layout</h2><p>ReliQ uses an Array of Structures of Arrays (AoSoA) memory layout for optimal SIMD and GPU performance:</p>
<p><pre class="listing">Traditional AoS:  [s0e0, s0e1, s1e0, s1e1, s2e0, s2e1, ...]
ReliQ AoSoA (VW=4): [s0e0, s1e0, s2e0, s3e0,  ← element 0, group 0
                      s0e1, s1e1, s2e1, s3e1,  ← element 1, group 0
                      s4e0, s5e0, s6e0, s7e0,  ← element 0, group 1
                      s4e1, s5e1, s6e1, s7e1]  ← element 1, group 1</pre></p>
<p><strong>Index formula</strong>: For site <tt class="docutils literal"><span class="pre">s</span></tt> with element index <tt class="docutils literal"><span class="pre">i</span></tt>:</p>
<p><pre class="listing">group = s / VW
lane  = s mod VW
index = group * (elemsPerSite * VW) + i * VW + lane</pre></p>
<p>Where <tt class="docutils literal"><span class="pre">VW</span></tt> (VectorWidth) is typically 8 for CPU (AVX2) or 32 for GPU.</p>

<h2 id="stencil-operations">Stencil Operations</h2><p>The unified stencil system provides neighbor access that works identically across all backends:</p>
<p><pre class="listing"><span class="Comment"># Create a lattice</span>
<span class="Keyword">let</span> <span class="Identifier">lat</span> <span class="Operator">=</span> <span class="Identifier">newSimpleCubicLattice</span><span class="Punctuation">(</span><span class="Punctuation">[</span><span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">16</span><span class="Punctuation">]</span><span class="Punctuation">)</span>

<span class="Comment"># Create a nearest-neighbor stencil (2*D points for D dimensions)</span>
<span class="Keyword">let</span> <span class="Identifier">pattern</span> <span class="Operator">=</span> <span class="Identifier">nearestNeighborStencil</span><span class="Punctuation">(</span><span class="Identifier">lat</span><span class="Punctuation">)</span>
<span class="Keyword">let</span> <span class="Identifier">stencil</span> <span class="Operator">=</span> <span class="Identifier">newLatticeStencil</span><span class="Punctuation">(</span><span class="Identifier">pattern</span><span class="Punctuation">,</span> <span class="Identifier">lat</span><span class="Punctuation">)</span>

<span class="Comment"># Direction API</span>
<span class="Keyword">let</span> <span class="Identifier">fwdX</span> <span class="Operator">=</span> <span class="Identifier">stencil</span><span class="Operator">.</span><span class="Identifier">fwd</span><span class="Punctuation">(</span><span class="DecNumber">0</span><span class="Punctuation">)</span>  <span class="Comment"># Forward in x</span>
<span class="Keyword">let</span> <span class="Identifier">bwdT</span> <span class="Operator">=</span> <span class="Identifier">stencil</span><span class="Operator">.</span><span class="Identifier">bwd</span><span class="Punctuation">(</span><span class="DecNumber">3</span><span class="Punctuation">)</span>  <span class="Comment"># Backward in t</span>

<span class="Comment"># Neighbor access in each loops</span>
<span class="Identifier">each</span> <span class="Identifier">vDst</span><span class="Punctuation">,</span> <span class="Identifier">vSrc</span><span class="Punctuation">,</span> <span class="Identifier">stencil</span><span class="Punctuation">,</span> <span class="Identifier">n</span><span class="Punctuation">:</span>
  <span class="Keyword">let</span> <span class="Identifier">nbrFwd</span> <span class="Operator">=</span> <span class="Identifier">stencil</span><span class="Operator">.</span><span class="Identifier">neighbor</span><span class="Punctuation">(</span><span class="Identifier">n</span><span class="Punctuation">,</span> <span class="Identifier">stencil</span><span class="Operator">.</span><span class="Identifier">fwd</span><span class="Punctuation">(</span><span class="DecNumber">0</span><span class="Punctuation">)</span><span class="Operator">.</span><span class="Identifier">idx</span><span class="Punctuation">)</span>
  <span class="Keyword">let</span> <span class="Identifier">nbrBwd</span> <span class="Operator">=</span> <span class="Identifier">stencil</span><span class="Operator">.</span><span class="Identifier">neighbor</span><span class="Punctuation">(</span><span class="Identifier">n</span><span class="Punctuation">,</span> <span class="Identifier">stencil</span><span class="Operator">.</span><span class="Identifier">bwd</span><span class="Punctuation">(</span><span class="DecNumber">0</span><span class="Punctuation">)</span><span class="Operator">.</span><span class="Identifier">idx</span><span class="Punctuation">)</span>
  <span class="Comment"># Discrete Laplacian: ψ(x+μ) + ψ(x-μ) - 2ψ(x)</span>
  <span class="Identifier">vDst</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="Identifier">vSrc</span><span class="Punctuation">[</span><span class="Identifier">nbrFwd</span><span class="Punctuation">]</span> <span class="Operator">+</span> <span class="Identifier">vSrc</span><span class="Punctuation">[</span><span class="Identifier">nbrBwd</span><span class="Punctuation">]</span> <span class="Operator">-</span> <span class="FloatNumber">2.0</span> <span class="Operator">*</span> <span class="Identifier">vSrc</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span></pre></p>

<h2 id="license">License</h2><p>MIT License — Copyright (c) 2025 reliq-lft</p>
<p>See <a class="reference external" href="https://github.com/reliq-lft/ReliQ/blob/main/LICENSE">LICENSE</a> for details. </p>



      <div class="twelve-columns footer">
        <span class="nim-sprite"></span>
        <br>
        <small style="color: var(--hint);">Made with Nim. Generated: 2026-02-07 04:08:32 UTC</small>
      </div>
    </div>
  </div>
  
</body>
</html>

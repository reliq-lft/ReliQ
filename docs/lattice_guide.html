<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--  This file is generated by Nim. -->
<html xmlns="https://www.w3.org/1999/xhtml" xml:lang="en" lang="en" data-theme="auto">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>lattice_guide</title>

<!-- Google fonts -->
<link href='https://fonts.googleapis.com/css?family=Lato:400,600,900' rel='stylesheet' type='text/css'/>
<link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,500,600' rel='stylesheet' type='text/css'/>

<!-- Favicon -->
<link rel="shortcut icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAUAAAAF////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAIAAABbAAAAlQAAAKIAAACbAAAAmwAAAKIAAACVAAAAWwAAAAL///8A////AP///wD///8A////AAAAABQAAADAAAAAYwAAAA3///8A////AP///wD///8AAAAADQAAAGMAAADAAAAAFP///wD///8A////AP///wAAAACdAAAAOv///wD///8A////AP///wD///8A////AP///wD///8AAAAAOgAAAJ3///8A////AP///wAAAAAnAAAAcP///wAAAAAoAAAASv///wD///8A////AP///wAAAABKAAAAKP///wAAAABwAAAAJ////wD///8AAAAAgQAAABwAAACIAAAAkAAAAJMAAACtAAAAFQAAABUAAACtAAAAkwAAAJAAAACIAAAAHAAAAIH///8A////AAAAAKQAAACrAAAAaP///wD///8AAAAARQAAANIAAADSAAAARf///wD///8AAAAAaAAAAKsAAACk////AAAAADMAAACcAAAAnQAAABj///8A////AP///wAAAAAYAAAAGP///wD///8A////AAAAABgAAACdAAAAnAAAADMAAAB1AAAAwwAAAP8AAADpAAAAsQAAAE4AAAAb////AP///wAAAAAbAAAATgAAALEAAADpAAAA/wAAAMMAAAB1AAAAtwAAAOkAAAD/AAAA/wAAAP8AAADvAAAA3gAAAN4AAADeAAAA3gAAAO8AAAD/AAAA/wAAAP8AAADpAAAAtwAAAGUAAAA/AAAA3wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAADfAAAAPwAAAGX///8A////AAAAAEgAAADtAAAAvwAAAL0AAADGAAAA7wAAAO8AAADGAAAAvQAAAL8AAADtAAAASP///wD///8A////AP///wD///8AAAAAO////wD///8A////AAAAAIcAAACH////AP///wD///8AAAAAO////wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A//8AAP//AAD4HwAA7/cAAN/7AAD//wAAoYUAAJ55AACf+QAAh+EAAAAAAADAAwAA4AcAAP5/AAD//wAA//8AAA=="/>
<link rel="icon" type="image/png" sizes="32x32" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAA3XAAAN1wFCKJt4AAAAB3RJTUUH4QQQEwksSS9ZWwAAAk1JREFUWMPtll2ITVEUx39nn/O7Y5qR8f05wtCUUr6ZIS++8pEnkZInPImneaCQ5METNdOkeFBKUhMPRIkHKfEuUZSUlGlKPN2TrgfncpvmnntnmlEyq1Z7t89/rf9a6+y99oZxGZf/XeIq61EdtgKXgdXA0xrYAvBjOIF1AI9zvjcC74BSpndrJPkBWDScTF8Aa4E3wDlgHbASaANmVqlcCnwHvgDvgVfAJ+AikAAvgfVZwLnSVZHZaOuKoQi3ZOMi4NkYkpe1p4J7A8BpYAD49hfIy/oqG0+hLomiKP2L5L+1ubn5115S+3OAn4EnwBlgMzCjyt6ZAnQCJ4A7wOs88iRJHvw50HoujuPBoCKwHWiosy8MdfZnAdcHk8dxXFJ3VQbQlCTJvRBCGdRbD4M6uc5glpY3eAihpN5S5w12diSEcCCEcKUO4ljdr15T76ur1FDDLIQQ3qv71EdDOe3Kxj3leRXyk+pxdWnFWod6Wt2bY3de3aSuUHcPBVimHs7mK9WrmeOF6lR1o9qnzskh2ar2qm1qizpfXaPeVGdlmGN5pb09qMxz1Xb1kLqgzn1RyH7JUXW52lr5e/Kqi9qpto7V1atuUzfnARrV7jEib1T76gG2qxdGmXyiekkt1GswPTtek0aBfJp6YySGBfWg2tPQ0FAYgf1stUfdmdcjarbYJEniKIq6gY/Aw+zWHAC+p2labGpqiorFYgGYCEzN7oQdQClN07O1/EfDyGgC0ALMBdYAi4FyK+4H3gLPsxfR1zRNi+NP7nH5J+QntnXe5B5mpfQAAAAASUVORK5CYII=">

<!-- CSS -->
<link rel="stylesheet" type="text/css" href="nimdoc.out.css?v=2.2.4">

<!-- JS -->
<script type="text/javascript" src="dochack.js?v=2.2.4"></script>
</head>
<body>
  <div class="document" id="documentId">
    <div class="container">
      <h1 class="title">lattice_guide</h1>
      
<h1 id="lattice-infrastructure">Lattice Infrastructure</h1><p>The lattice layer defines the spatial geometry of the simulation and provides all coordinate, indexing, and stencil infrastructure used by the tensor and backend layers.</p>

<h2 id="lattice-concept">Lattice Concept</h2><p>Every lattice type must satisfy the <tt class="docutils literal"><span class="pre">Lattice[D]</span></tt> concept, parameterized by the number of spatial dimensions <tt class="docutils literal"><span class="pre">D</span></tt> (a compile-time <tt class="docutils literal"><span class="pre">static[int]</span></tt>). A conforming type exposes three arrays:</p>
<table border="1" class="docutils"><tr><th>Field</th><th>Type</th><th>Description</th></tr>
<tr><td><tt class="docutils literal"><span class="pre">globalGrid</span></tt></td><td><tt class="docutils literal"><span class="pre">array[D, int]</span></tt></td><td>Full extent per dimension</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">mpiGrid</span></tt></td><td><tt class="docutils literal"><span class="pre">array[D, int]</span></tt></td><td>MPI process grid (<tt class="docutils literal"><span class="pre">-1</span></tt> for auto)</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">ghostGrid</span></tt></td><td><tt class="docutils literal"><span class="pre">array[D, int]</span></tt></td><td>Ghost (halo) width per dimension</td></tr>
</table><p>The concept lives in its own module (<tt class="docutils literal"><span class="pre">lattice/latticeconcept</span></tt>) to break circular imports between <tt class="docutils literal"><span class="pre">lattice.nim</span></tt> and <tt class="docutils literal"><span class="pre">lattice/stencil.nim</span></tt>.</p>

<h2 id="simplecubiclattice">SimpleCubicLattice</h2><p>The only concrete lattice type currently provided is <tt class="docutils literal"><span class="pre">SimpleCubicLattice[D]</span></tt>, which satisfies <tt class="docutils literal"><span class="pre">Lattice[D]</span></tt>.</p>

<h3 id="construction">Construction</h3><p><pre class="listing"><span class="Keyword">import</span> <span class="Identifier">reliq</span>

<span class="Comment"># Minimal: auto-detect MPI decomposition, no ghosts</span>
<span class="Keyword">let</span> <span class="Identifier">lat</span> <span class="Operator">=</span> <span class="Identifier">newSimpleCubicLattice</span><span class="Punctuation">(</span><span class="Punctuation">[</span><span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">16</span><span class="Punctuation">]</span><span class="Punctuation">)</span>

<span class="Comment"># Explicit MPI grid (4 ranks along t-axis)</span>
<span class="Keyword">let</span> <span class="Identifier">lat2</span> <span class="Operator">=</span> <span class="Identifier">newSimpleCubicLattice</span><span class="Punctuation">(</span><span class="Punctuation">[</span><span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">16</span><span class="Punctuation">]</span><span class="Punctuation">,</span> <span class="Punctuation">[</span><span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">4</span><span class="Punctuation">]</span><span class="Punctuation">)</span>

<span class="Comment"># Full control: MPI grid + ghost widths</span>
<span class="Keyword">let</span> <span class="Identifier">lat3</span> <span class="Operator">=</span> <span class="Identifier">newSimpleCubicLattice</span><span class="Punctuation">(</span><span class="Punctuation">[</span><span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">16</span><span class="Punctuation">]</span><span class="Punctuation">,</span> <span class="Punctuation">[</span><span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">4</span><span class="Punctuation">]</span><span class="Punctuation">,</span> <span class="Punctuation">[</span><span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">]</span><span class="Punctuation">)</span></pre></p>
<ul class="simple"><li><strong>``globalGrid``</strong> — The total lattice extent.  All dimensions must be evenly divisible by their MPI grid factors.</li>
<li><strong>``mpiGrid``</strong> — How MPI ranks are distributed.  Use <tt class="docutils literal"><span class="pre">-1</span></tt> for auto-detection via Global Arrays (requires GA to be initialized first).</li>
<li><strong>``ghostGrid``</strong> — Width of the ghost/halo region per dimension.  Used by stencils and ghost exchange.  Default is <tt class="docutils literal"><span class="pre">0</span></tt> (no ghosts).</li>
</ul>

<h3 id="properties">Properties</h3><p><pre class="listing"><span class="Identifier">lat</span><span class="Operator">.</span><span class="Identifier">globalGrid</span>   <span class="Comment"># [8, 8, 8, 16]</span>
<span class="Identifier">lat</span><span class="Operator">.</span><span class="Identifier">mpiGrid</span>      <span class="Comment"># [1, 1, 1, 4]</span>
<span class="Identifier">lat</span><span class="Operator">.</span><span class="Identifier">ghostGrid</span>    <span class="Comment"># [1, 1, 1, 1]</span></pre></p>

<h2 id="coordinate-indexing">Coordinate Indexing</h2><p>The <tt class="docutils literal"><span class="pre">lattice/indexing</span></tt> module provides pure-function coordinate conversion utilities.  All use <strong>little-endian</strong> flat-index ordering: dimension 0 varies fastest.</p>
<table border="1" class="docutils"><tr><th>Proc</th><th>Signature</th><th>Description</th></tr>
<tr><td><tt class="docutils literal"><span class="pre">flatToCoords</span></tt></td><td><tt class="docutils literal"><span class="pre">(idx: int, dims: array[D, int]): array[D, int]</span></tt></td><td>Flat index → coordinates</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">coordsToFlat</span></tt></td><td><tt class="docutils literal"><span class="pre">(coords, dims: array[D, int]): int</span></tt></td><td>Coordinates → flat index</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">localToGlobalCoords</span></tt></td><td><tt class="docutils literal"><span class="pre">(localCoords, lo: array[D, int]): array[D, int]</span></tt></td><td>Local → global offset</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">globalToLocalCoords</span></tt></td><td><tt class="docutils literal"><span class="pre">(globalCoords, lo: array[D, int]): array[D, int]</span></tt></td><td>Global → local offset</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">localFlatToGlobalFlat</span></tt></td><td><tt class="docutils literal"><span class="pre">(localIdx: int, localDims, globalDims, lo): int</span></tt></td><td>Flat local → flat global</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">globalFlatToLocalFlat</span></tt></td><td><tt class="docutils literal"><span class="pre">(globalIdx: int, localDims, globalDims, lo): int</span></tt></td><td>Flat global → flat local</td></tr>
</table><p><strong>Example:</strong></p>
<p><pre class="listing"><span class="Keyword">import</span> <span class="Identifier">reliq</span>

<span class="Keyword">let</span> <span class="Identifier">dims</span> <span class="Operator">=</span> <span class="Punctuation">[</span><span class="DecNumber">4</span><span class="Punctuation">,</span> <span class="DecNumber">4</span><span class="Punctuation">]</span>
<span class="Keyword">let</span> <span class="Identifier">coords</span> <span class="Operator">=</span> <span class="Identifier">flatToCoords</span><span class="Punctuation">(</span><span class="DecNumber">5</span><span class="Punctuation">,</span> <span class="Identifier">dims</span><span class="Punctuation">)</span>   <span class="Comment"># [1, 1]  (5 = 1 + 1*4)</span>
<span class="Keyword">let</span> <span class="Identifier">flat</span> <span class="Operator">=</span> <span class="Identifier">coordsToFlat</span><span class="Punctuation">(</span><span class="Identifier">coords</span><span class="Punctuation">,</span> <span class="Identifier">dims</span><span class="Punctuation">)</span> <span class="Comment"># 5</span></pre></p>

<h2 id="stencil-operations">Stencil Operations</h2><p>The unified stencil system lives in <tt class="docutils literal"><span class="pre">lattice/stencil</span></tt> and provides a single <tt class="docutils literal"><span class="pre">LatticeStencil[D]</span></tt> type that works identically across all backends.</p>

<h3 id="stencil-patterns">Stencil Patterns</h3><p>A <tt class="docutils literal"><span class="pre">StencilPattern[D]</span></tt> defines the shape of a stencil as a set of offsets relative to the center site:</p>
<p><pre class="listing"><span class="Keyword">import</span> <span class="Identifier">reliq</span>

<span class="Comment"># Built-in nearest-neighbor stencil for 4D</span>
<span class="Keyword">let</span> <span class="Identifier">nn</span> <span class="Operator">=</span> <span class="Identifier">nearestNeighborStencil</span><span class="Punctuation">[</span><span class="DecNumber">4</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Punctuation">)</span>
<span class="Identifier">echo</span> <span class="Identifier">nn</span><span class="Operator">.</span><span class="Identifier">name</span>      <span class="Comment"># &quot;nearest_neighbor&quot;</span>
<span class="Identifier">echo</span> <span class="Identifier">nn</span><span class="Operator">.</span><span class="Identifier">nPoints</span>   <span class="Comment"># 8  (±1 in each of 4 dims)</span>

<span class="Comment"># Built-in Laplacian stencil</span>
<span class="Keyword">let</span> <span class="Identifier">lap</span> <span class="Operator">=</span> <span class="Identifier">laplacianStencil</span><span class="Punctuation">[</span><span class="DecNumber">4</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Punctuation">)</span>

<span class="Comment"># Lattice-inferred patterns (reads D from lattice type)</span>
<span class="Keyword">let</span> <span class="Identifier">lat</span> <span class="Operator">=</span> <span class="Identifier">newSimpleCubicLattice</span><span class="Punctuation">(</span><span class="Punctuation">[</span><span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">16</span><span class="Punctuation">]</span><span class="Punctuation">)</span>
<span class="Keyword">let</span> <span class="Identifier">nn2</span> <span class="Operator">=</span> <span class="Identifier">nearestNeighborStencil</span><span class="Punctuation">(</span><span class="Identifier">lat</span><span class="Punctuation">)</span>

<span class="Comment"># Custom patterns</span>
<span class="Keyword">var</span> <span class="Identifier">custom</span> <span class="Operator">=</span> <span class="Identifier">newStencilPattern</span><span class="Punctuation">[</span><span class="DecNumber">2</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="StringLit">&quot;custom&quot;</span><span class="Punctuation">)</span>
<span class="Identifier">custom</span><span class="Operator">.</span><span class="Identifier">addPoint</span><span class="Punctuation">(</span><span class="Punctuation">[</span><span class="DecNumber">2</span><span class="Punctuation">,</span> <span class="DecNumber">0</span><span class="Punctuation">]</span><span class="Punctuation">)</span>   <span class="Comment"># Two steps in x</span>
<span class="Identifier">custom</span><span class="Operator">.</span><span class="Identifier">addPoint</span><span class="Punctuation">(</span><span class="Punctuation">[</span><span class="DecNumber">0</span><span class="Punctuation">,</span> <span class="DecNumber">2</span><span class="Punctuation">]</span><span class="Punctuation">)</span>   <span class="Comment"># Two steps in y</span></pre></p>

<h3 id="latticestencil">LatticeStencil</h3><p>A <tt class="docutils literal"><span class="pre">LatticeStencil[D]</span></tt> binds a pattern to a specific lattice, pre-computing all neighbor offsets (including ghost region handling):</p>
<p><pre class="listing"><span class="Keyword">import</span> <span class="Identifier">reliq</span>

<span class="Keyword">let</span> <span class="Identifier">lat</span> <span class="Operator">=</span> <span class="Identifier">newSimpleCubicLattice</span><span class="Punctuation">(</span><span class="Punctuation">[</span><span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">16</span><span class="Punctuation">]</span><span class="Punctuation">,</span> <span class="Punctuation">[</span><span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">]</span><span class="Punctuation">,</span> <span class="Punctuation">[</span><span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">]</span><span class="Punctuation">)</span>

<span class="Comment"># Create stencil from pattern</span>
<span class="Keyword">let</span> <span class="Identifier">stencil</span> <span class="Operator">=</span> <span class="Identifier">newLatticeStencil</span><span class="Punctuation">(</span><span class="Identifier">nearestNeighborStencil</span><span class="Punctuation">[</span><span class="DecNumber">4</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">,</span> <span class="Identifier">lat</span><span class="Punctuation">)</span>

<span class="Comment"># Direct construction from lattice (uses nearest-neighbor by default)</span>
<span class="Keyword">let</span> <span class="Identifier">stencil2</span> <span class="Operator">=</span> <span class="Identifier">newLatticeStencil</span><span class="Punctuation">(</span><span class="Identifier">lat</span><span class="Punctuation">)</span></pre></p>

<h3 id="neighbor-access">Neighbor Access</h3><p>Inside an <tt class="docutils literal"><span class="pre">each</span></tt> loop, use the <strong>shift API</strong>:</p>
<p><pre class="listing"><span class="Keyword">for</span> <span class="Identifier">n</span> <span class="Keyword">in</span> <span class="Identifier">each</span> <span class="FloatNumber">0.</span><span class="Operator">.&lt;</span><span class="Identifier">vC</span><span class="Operator">.</span><span class="Identifier">numSites</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">:</span>
  <span class="Keyword">let</span> <span class="Identifier">fwd_x</span> <span class="Operator">=</span> <span class="Identifier">stencil</span><span class="Operator">.</span><span class="Identifier">fwd</span><span class="Punctuation">(</span><span class="Identifier">n</span><span class="Punctuation">,</span> <span class="DecNumber">0</span><span class="Punctuation">)</span>   <span class="Comment"># Forward neighbor in x</span>
  <span class="Keyword">let</span> <span class="Identifier">bwd_x</span> <span class="Operator">=</span> <span class="Identifier">stencil</span><span class="Operator">.</span><span class="Identifier">bwd</span><span class="Punctuation">(</span><span class="Identifier">n</span><span class="Punctuation">,</span> <span class="DecNumber">0</span><span class="Punctuation">)</span>   <span class="Comment"># Backward neighbor in x</span>
  <span class="Keyword">let</span> <span class="Identifier">fwd_t</span> <span class="Operator">=</span> <span class="Identifier">stencil</span><span class="Operator">.</span><span class="Identifier">fwd</span><span class="Punctuation">(</span><span class="Identifier">n</span><span class="Punctuation">,</span> <span class="DecNumber">3</span><span class="Punctuation">)</span>   <span class="Comment"># Forward neighbor in t</span>
  <span class="Identifier">vC</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="Identifier">vA</span><span class="Punctuation">[</span><span class="Identifier">fwd_x</span><span class="Punctuation">]</span> <span class="Operator">+</span> <span class="Identifier">vA</span><span class="Punctuation">[</span><span class="Identifier">bwd_x</span><span class="Punctuation">]</span> <span class="Operator">-</span> <span class="FloatNumber">2.0</span> <span class="Operator">*</span> <span class="Identifier">vA</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span></pre></p>
<ul class="simple"><li><tt class="docutils literal"><span class="pre">stencil.fwd(n, dim)</span></tt> — Returns a <tt class="docutils literal"><span class="pre">StencilShift</span></tt> for the forward neighbor of site <tt class="docutils literal"><span class="pre">n</span></tt> in dimension <tt class="docutils literal"><span class="pre">dim</span></tt>.</li>
<li><tt class="docutils literal"><span class="pre">stencil.bwd(n, dim)</span></tt> — Backward neighbor.</li>
<li><tt class="docutils literal"><span class="pre">stencil.shift(n, point)</span></tt> — Access an arbitrary stencil point by index.</li>
</ul>

<h3 id="pathminusbased-stencils">Path-Based Stencils</h3><p>For Wilson loops and transport paths:</p>
<p><pre class="listing"><span class="Comment"># Plaquette path: fwd(mu), fwd(nu), bwd(mu), bwd(nu)</span>
<span class="Keyword">let</span> <span class="Identifier">path</span> <span class="Operator">=</span> <span class="Identifier">plaquettePath</span><span class="Punctuation">(</span><span class="DecNumber">0</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">)</span>  <span class="Comment"># xy-plaquette</span>

<span class="Comment"># Rectangle path</span>
<span class="Keyword">let</span> <span class="Identifier">rect</span> <span class="Operator">=</span> <span class="Identifier">rectanglePath</span><span class="Punctuation">(</span><span class="DecNumber">0</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">2</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">)</span>  <span class="Comment"># 2×1 rectangle in xy-plane</span>

<span class="Comment"># Convert path to stencil pattern</span>
<span class="Keyword">let</span> <span class="Identifier">pattern</span> <span class="Operator">=</span> <span class="Identifier">pathToStencil</span><span class="Punctuation">[</span><span class="DecNumber">4</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Identifier">path</span><span class="Punctuation">)</span></pre></p>

<h3 id="direction-types">Direction Types</h3><p>Type-safe direction indexing:</p>
<p><pre class="listing"><span class="Keyword">let</span> <span class="Identifier">d</span> <span class="Operator">=</span> <span class="Identifier">Direction</span><span class="Punctuation">(</span><span class="DecNumber">0</span><span class="Punctuation">)</span>
<span class="Identifier">echo</span> <span class="Identifier">d</span>    <span class="Comment"># 0</span>
<span class="Keyword">let</span> <span class="Identifier">sd</span> <span class="Operator">=</span> <span class="Identifier">forward</span><span class="Punctuation">(</span><span class="Identifier">d</span><span class="Punctuation">)</span>    <span class="Comment"># SignedDirection(dir: 0, sign: +1)</span>
<span class="Keyword">let</span> <span class="Identifier">bd</span> <span class="Operator">=</span> <span class="Identifier">backward</span><span class="Punctuation">(</span><span class="Identifier">d</span><span class="Punctuation">)</span>   <span class="Comment"># SignedDirection(dir: 0, sign: -1)</span>

<span class="Comment"># Named constants</span>
<span class="Identifier">echo</span> <span class="Identifier">X</span>   <span class="Comment"># Direction(0)</span>
<span class="Identifier">echo</span> <span class="Identifier">Y</span>   <span class="Comment"># Direction(1)</span>
<span class="Identifier">echo</span> <span class="Identifier">Z</span>   <span class="Comment"># Direction(2)</span>
<span class="Identifier">echo</span> <span class="Identifier">T</span>   <span class="Comment"># Direction(3)</span>

<span class="Comment"># Iterators</span>
<span class="Keyword">for</span> <span class="Identifier">d</span> <span class="Keyword">in</span> <span class="Identifier">directions</span><span class="Punctuation">(</span><span class="DecNumber">4</span><span class="Punctuation">)</span><span class="Punctuation">:</span>
  <span class="Identifier">echo</span> <span class="Identifier">d</span>  <span class="Comment"># 0, 1, 2, 3</span>

<span class="Keyword">for</span> <span class="Identifier">sd</span> <span class="Keyword">in</span> <span class="Identifier">allDirections</span><span class="Punctuation">(</span><span class="DecNumber">4</span><span class="Punctuation">)</span><span class="Punctuation">:</span>
  <span class="Identifier">echo</span> <span class="Identifier">sd</span>  <span class="Comment"># ±0, ±1, ±2, ±3</span></pre></p>

<h3 id="backend-detection">Backend Detection</h3><p>The stencil system auto-detects the active backend at construction time:</p>
<table border="1" class="docutils"><tr><th>Backend</th><th><tt class="docutils literal"><span class="pre">StencilBackend</span></tt></th><th>Offset format</th></tr>
<tr><td>OpenCL</td><td><tt class="docutils literal"><span class="pre">sbOpenCL</span></tt></td><td>Flat offsets for GPU buffers</td></tr>
<tr><td>SYCL</td><td><tt class="docutils literal"><span class="pre">sbSycl</span></tt></td><td>Flat offsets for GPU buffers</td></tr>
<tr><td>OpenMP (SIMD)</td><td><tt class="docutils literal"><span class="pre">sbSimd</span></tt></td><td>Outer/lane offset pairs</td></tr>
<tr><td>Scalar</td><td><tt class="docutils literal"><span class="pre">sbScalar</span></tt></td><td>Flat coordinate offsets</td></tr>
</table>
<h2 id="module-reference">Module Reference</h2><table border="1" class="docutils"><tr><th>Module</th><th>Description</th></tr>
<tr><td><a class="reference external" href="lattice/latticeconcept.html">lattice/latticeconcept</a></td><td><tt class="docutils literal"><span class="pre">Lattice[D]</span></tt> concept definition</td></tr>
<tr><td><a class="reference external" href="lattice/simplecubiclattice.html">lattice/simplecubiclattice</a></td><td><tt class="docutils literal"><span class="pre">SimpleCubicLattice[D]</span></tt> implementation</td></tr>
<tr><td><a class="reference external" href="lattice/stencil.html">lattice/stencil</a></td><td>Unified stencil operations</td></tr>
<tr><td><a class="reference external" href="lattice/indexing.html">lattice/indexing</a></td><td>Coordinate conversion utilities</td></tr>
</table>


      <div class="twelve-columns footer">
        <span class="nim-sprite"></span>
        <br>
        <small style="color: var(--hint);">Made with Nim. Generated: 2026-02-07 07:38:43 UTC</small>
      </div>
    </div>
  </div>
  
</body>
</html>

<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--  This file is generated by Nim. -->
<html xmlns="https://www.w3.org/1999/xhtml" xml:lang="en" lang="en" data-theme="auto">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>tensor_guide</title>

<!-- Google fonts -->
<link href='https://fonts.googleapis.com/css?family=Lato:400,600,900' rel='stylesheet' type='text/css'/>
<link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,500,600' rel='stylesheet' type='text/css'/>

<!-- Favicon -->
<link rel="shortcut icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAUAAAAF////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAIAAABbAAAAlQAAAKIAAACbAAAAmwAAAKIAAACVAAAAWwAAAAL///8A////AP///wD///8A////AAAAABQAAADAAAAAYwAAAA3///8A////AP///wD///8AAAAADQAAAGMAAADAAAAAFP///wD///8A////AP///wAAAACdAAAAOv///wD///8A////AP///wD///8A////AP///wD///8AAAAAOgAAAJ3///8A////AP///wAAAAAnAAAAcP///wAAAAAoAAAASv///wD///8A////AP///wAAAABKAAAAKP///wAAAABwAAAAJ////wD///8AAAAAgQAAABwAAACIAAAAkAAAAJMAAACtAAAAFQAAABUAAACtAAAAkwAAAJAAAACIAAAAHAAAAIH///8A////AAAAAKQAAACrAAAAaP///wD///8AAAAARQAAANIAAADSAAAARf///wD///8AAAAAaAAAAKsAAACk////AAAAADMAAACcAAAAnQAAABj///8A////AP///wAAAAAYAAAAGP///wD///8A////AAAAABgAAACdAAAAnAAAADMAAAB1AAAAwwAAAP8AAADpAAAAsQAAAE4AAAAb////AP///wAAAAAbAAAATgAAALEAAADpAAAA/wAAAMMAAAB1AAAAtwAAAOkAAAD/AAAA/wAAAP8AAADvAAAA3gAAAN4AAADeAAAA3gAAAO8AAAD/AAAA/wAAAP8AAADpAAAAtwAAAGUAAAA/AAAA3wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAADfAAAAPwAAAGX///8A////AAAAAEgAAADtAAAAvwAAAL0AAADGAAAA7wAAAO8AAADGAAAAvQAAAL8AAADtAAAASP///wD///8A////AP///wD///8AAAAAO////wD///8A////AAAAAIcAAACH////AP///wD///8AAAAAO////wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A//8AAP//AAD4HwAA7/cAAN/7AAD//wAAoYUAAJ55AACf+QAAh+EAAAAAAADAAwAA4AcAAP5/AAD//wAA//8AAA=="/>
<link rel="icon" type="image/png" sizes="32x32" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAA3XAAAN1wFCKJt4AAAAB3RJTUUH4QQQEwksSS9ZWwAAAk1JREFUWMPtll2ITVEUx39nn/O7Y5qR8f05wtCUUr6ZIS++8pEnkZInPImneaCQ5METNdOkeFBKUhMPRIkHKfEuUZSUlGlKPN2TrgfncpvmnntnmlEyq1Z7t89/rf9a6+y99oZxGZf/XeIq61EdtgKXgdXA0xrYAvBjOIF1AI9zvjcC74BSpndrJPkBWDScTF8Aa4E3wDlgHbASaANmVqlcCnwHvgDvgVfAJ+AikAAvgfVZwLnSVZHZaOuKoQi3ZOMi4NkYkpe1p4J7A8BpYAD49hfIy/oqG0+hLomiKP2L5L+1ubn5115S+3OAn4EnwBlgMzCjyt6ZAnQCJ4A7wOs88iRJHvw50HoujuPBoCKwHWiosy8MdfZnAdcHk8dxXFJ3VQbQlCTJvRBCGdRbD4M6uc5glpY3eAihpN5S5w12diSEcCCEcKUO4ljdr15T76ur1FDDLIQQ3qv71EdDOe3Kxj3leRXyk+pxdWnFWod6Wt2bY3de3aSuUHcPBVimHs7mK9WrmeOF6lR1o9qnzskh2ar2qm1qizpfXaPeVGdlmGN5pb09qMxz1Xb1kLqgzn1RyH7JUXW52lr5e/Kqi9qpto7V1atuUzfnARrV7jEib1T76gG2qxdGmXyiekkt1GswPTtek0aBfJp6YySGBfWg2tPQ0FAYgf1stUfdmdcjarbYJEniKIq6gY/Aw+zWHAC+p2labGpqiorFYgGYCEzN7oQdQClN07O1/EfDyGgC0ALMBdYAi4FyK+4H3gLPsxfR1zRNi+NP7nH5J+QntnXe5B5mpfQAAAAASUVORK5CYII=">

<!-- CSS -->
<link rel="stylesheet" type="text/css" href="nimdoc.out.css?v=2.2.4">

<!-- JS -->
<script type="text/javascript" src="dochack.js?v=2.2.4"></script>
</head>
<body>
  <div class="document" id="documentId">
    <div class="container">
      <h1 class="title">tensor_guide</h1>
      
<h1 id="tensor-fields">Tensor Fields</h1><p>The tensor layer is the core data abstraction in ReliQ.  It provides three levels of tensor field representation — distributed, local, and device-side — connected by a well-defined data flow.</p>

<h2 id="data-flow">Data Flow</h2><p><pre class="listing">TensorField[D,R,L,T]           ← Distributed (GA + MPI)
    │ newLocalTensorField()
    ▼
LocalTensorField[D,R,L,T]      ← Contiguous host buffer
    │ newTensorFieldView()
    ▼
TensorFieldView[L,T]           ← Device-side AoSoA buffers
    │ each macro
    ▼
Backend dispatch (OpenCL / SYCL / OpenMP)</pre></p>

<h2 id="tensorfield-distributed">TensorField (Distributed)</h2><p><tt class="docutils literal"><span class="pre">TensorField[D, R, L, T]</span></tt> wraps a Global Array with automatic ghost regions and MPI decomposition.  Here <tt class="docutils literal"><span class="pre">D</span></tt> is the lattice dimension, <tt class="docutils literal"><span class="pre">R</span></tt> is the tensor rank (number of index dimensions), <tt class="docutils literal"><span class="pre">L</span></tt> is the lattice type, and <tt class="docutils literal"><span class="pre">T</span></tt> is the element type (<tt class="docutils literal"><span class="pre">float32</span></tt>, <tt class="docutils literal"><span class="pre">float64</span></tt>, <tt class="docutils literal"><span class="pre">Complex64</span></tt>, etc.).</p>

<h3 id="creation">Creation</h3><p><pre class="listing"><span class="Keyword">import</span> <span class="Identifier">reliq</span>

<span class="Identifier">parallel</span><span class="Punctuation">:</span>
  <span class="Keyword">let</span> <span class="Identifier">lat</span> <span class="Operator">=</span> <span class="Identifier">newSimpleCubicLattice</span><span class="Punctuation">(</span><span class="Punctuation">[</span><span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">16</span><span class="Punctuation">]</span><span class="Punctuation">,</span> <span class="Punctuation">[</span><span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">4</span><span class="Punctuation">]</span><span class="Punctuation">,</span> <span class="Punctuation">[</span><span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">]</span><span class="Punctuation">)</span>
  
  <span class="Keyword">block</span><span class="Punctuation">:</span>
    <span class="Comment"># Scalar field (rank 0, but stored as [1,1] for GA compatibility)</span>
    <span class="Keyword">var</span> <span class="Identifier">scalar</span> <span class="Operator">=</span> <span class="Identifier">lat</span><span class="Operator">.</span><span class="Identifier">newTensorField</span><span class="Punctuation">(</span><span class="Punctuation">[</span><span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">]</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">float64</span>
    
    <span class="Comment"># 3×3 matrix field</span>
    <span class="Keyword">var</span> <span class="Identifier">gauge</span> <span class="Operator">=</span> <span class="Identifier">lat</span><span class="Operator">.</span><span class="Identifier">newTensorField</span><span class="Punctuation">(</span><span class="Punctuation">[</span><span class="DecNumber">3</span><span class="Punctuation">,</span> <span class="DecNumber">3</span><span class="Punctuation">]</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">float64</span>
    
    <span class="Comment"># Complex 3×3 matrix field (e.g., SU(3) gauge links)</span>
    <span class="Keyword">var</span> <span class="Identifier">su3</span> <span class="Operator">=</span> <span class="Identifier">lat</span><span class="Operator">.</span><span class="Identifier">newTensorField</span><span class="Punctuation">(</span><span class="Punctuation">[</span><span class="DecNumber">3</span><span class="Punctuation">,</span> <span class="DecNumber">3</span><span class="Punctuation">]</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">Complex64</span>
    
    <span class="Comment"># 4-vector field</span>
    <span class="Keyword">var</span> <span class="Identifier">vec</span> <span class="Operator">=</span> <span class="Identifier">lat</span><span class="Operator">.</span><span class="Identifier">newTensorField</span><span class="Punctuation">(</span><span class="Punctuation">[</span><span class="DecNumber">4</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">]</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">float64</span></pre></p>
<p>The <tt class="docutils literal"><span class="pre">newTensorField</span></tt> macro accepts a shape array and element type.  The shape <tt class="docutils literal"><span class="pre">[3, 3]</span></tt> means a 3×3 matrix at each lattice site; <tt class="docutils literal"><span class="pre">[4, 1]</span></tt> means a length-4 vector.</p>

<h3 id="ga-memory-layout">GA Memory Layout</h3><p>Internally, a <tt class="docutils literal"><span class="pre">TensorField</span></tt> creates a <tt class="docutils literal"><span class="pre">(D + R + 1)</span></tt>-dimensional Global Array:</p>
<ul class="simple"><li><strong>Dimensions 0..D-1</strong> — Lattice spatial dimensions</li>
<li><strong>Dimensions D..D+R-1</strong> — Tensor index dimensions (shape)</li>
<li><strong>Dimension D+R</strong> — Complex/real dimension (size 2 for complex, 1 for real)</li>
</ul>
<p>Ghost regions of width 1 are added to <strong>all</strong> dimensions (a requirement of Global Arrays 5.8.2 — <tt class="docutils literal"><span class="pre">GA_Update_ghost_dir</span></tt> crashes if any dimension has ghost width 0).  This means the inner (tensor+complex) block has padded strides:</p>
<p><pre class="listing">Inner block size (real elements) = shape[0] * shape[1] * ... * complexFactor
Padded block size (with ghosts) = (shape[0]+2) * (shape[1]+2) * ... * (complexFactor+2)</pre></p>
<p>The <tt class="docutils literal"><span class="pre">innerBlockSize</span></tt> and <tt class="docutils literal"><span class="pre">innerPaddedBlockSize</span></tt> procs compute these values.</p>

<h3 id="ghost-exchange">Ghost Exchange</h3><p><pre class="listing"><span class="Comment"># Update ghosts in one dimension/direction</span>
<span class="Identifier">tensor</span><span class="Operator">.</span><span class="Identifier">updateGhosts</span><span class="Punctuation">(</span><span class="Identifier">dim</span><span class="Operator">=</span><span class="DecNumber">3</span><span class="Punctuation">,</span> <span class="Identifier">direction</span><span class="Operator">=</span><span class="DecNumber">1</span><span class="Punctuation">)</span>

<span class="Comment"># Update all ghost regions</span>
<span class="Identifier">tensor</span><span class="Operator">.</span><span class="Identifier">updateAllGhosts</span><span class="Punctuation">(</span><span class="Punctuation">)</span></pre></p>

<h3 id="direct-local-access">Direct Local Access</h3><p>For advanced use, you can access the raw GA pointer:</p>
<p><pre class="listing"><span class="Keyword">let</span> <span class="Identifier">rawPtr</span> <span class="Operator">=</span> <span class="Identifier">tensor</span><span class="Operator">.</span><span class="Identifier">accessLocal</span><span class="Punctuation">(</span><span class="Punctuation">)</span>
<span class="Comment"># ... use rawPtr with innerPaddedBlockSize strides ...</span>
<span class="Identifier">tensor</span><span class="Operator">.</span><span class="Identifier">releaseLocal</span><span class="Punctuation">(</span><span class="Punctuation">)</span></pre></p>
<p>However, the recommended approach is to use <tt class="docutils literal"><span class="pre">LocalTensorField</span></tt> which handles the padded-to-contiguous copy for you.</p>

<h2 id="localtensorfield-host-buffer">LocalTensorField (Host Buffer)</h2><p><tt class="docutils literal"><span class="pre">LocalTensorField[D, R, L, T]</span></tt> provides a contiguous host-memory copy of the rank-local partition.  It allocates a flat buffer and copies the real elements from the ghost-padded GA memory into contiguous AoS order:</p>
<p><pre class="listing">data[site * elemsPerSite + element]</pre></p>

<h3 id="creation-and-release">Creation and Release</h3><p><pre class="listing"><span class="Comment"># Create from a distributed TensorField</span>
<span class="Keyword">var</span> <span class="Identifier">local</span> <span class="Operator">=</span> <span class="Identifier">field</span><span class="Operator">.</span><span class="Identifier">newLocalTensorField</span><span class="Punctuation">(</span><span class="Punctuation">)</span>

<span class="Comment"># Access data...</span>
<span class="Keyword">for</span> <span class="Identifier">n</span> <span class="Keyword">in</span> <span class="Identifier">all</span> <span class="FloatNumber">0.</span><span class="Operator">.&lt;</span><span class="Identifier">local</span><span class="Operator">.</span><span class="Identifier">numSites</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">:</span>
  <span class="Keyword">var</span> <span class="Identifier">site</span> <span class="Operator">=</span> <span class="Identifier">local</span><span class="Operator">.</span><span class="Identifier">getSite</span><span class="Punctuation">(</span><span class="Identifier">n</span><span class="Punctuation">)</span>
  <span class="Identifier">site</span><span class="Punctuation">[</span><span class="DecNumber">0</span><span class="Punctuation">,</span> <span class="DecNumber">0</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="FloatNumber">1.0</span>

<span class="Comment"># IMPORTANT: Copy changes back to the distributed Global Array</span>
<span class="Identifier">local</span><span class="Operator">.</span><span class="Identifier">releaseLocalTensorField</span><span class="Punctuation">(</span><span class="Punctuation">)</span></pre></p>
<p><strong>Calling ``releaseLocalTensorField()`` is required</strong> after modifying data through a <tt class="docutils literal"><span class="pre">LocalTensorField</span></tt>.  This copies the contiguous buffer back into the ghost-padded GA memory and deallocates the buffer.</p>

<h3 id="properties">Properties</h3><table border="1" class="docutils"><tr><th>Proc</th><th>Returns</th><th>Description</th></tr>
<tr><td><tt class="docutils literal"><span class="pre">numSites()</span></tt></td><td><tt class="docutils literal"><span class="pre">int</span></tt></td><td>Number of local lattice sites</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">numGlobalSites()</span></tt></td><td><tt class="docutils literal"><span class="pre">int</span></tt></td><td>Total sites across all ranks</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">numElements()</span></tt></td><td><tt class="docutils literal"><span class="pre">int</span></tt></td><td>Total elements in local buffer</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">tensorElementsPerSite()</span></tt></td><td><tt class="docutils literal"><span class="pre">int</span></tt></td><td>Elements per lattice site</td></tr>
</table>
<h3 id="element-access">Element Access</h3><p><pre class="listing"><span class="Comment"># Direct element access</span>
<span class="Identifier">local</span><span class="Punctuation">[</span><span class="Identifier">idx</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="FloatNumber">3.14</span>       <span class="Comment"># Write element at flat index</span>
<span class="Keyword">let</span> <span class="Identifier">x</span> <span class="Operator">=</span> <span class="Identifier">local</span><span class="Punctuation">[</span><span class="Identifier">idx</span><span class="Punctuation">]</span>      <span class="Comment"># Read element at flat index</span>

<span class="Comment"># Site proxy access (preferred for the &quot;all&quot; loop)</span>
<span class="Keyword">var</span> <span class="Identifier">site</span> <span class="Operator">=</span> <span class="Identifier">local</span><span class="Operator">.</span><span class="Identifier">getSite</span><span class="Punctuation">(</span><span class="Identifier">n</span><span class="Punctuation">)</span>
<span class="Identifier">site</span><span class="Punctuation">[</span><span class="Identifier">i</span><span class="Punctuation">,</span> <span class="Identifier">j</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="FloatNumber">1.0</span>        <span class="Comment"># Matrix element (row, col)</span>
<span class="Identifier">site</span><span class="Punctuation">[</span><span class="Identifier">i</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="FloatNumber">2.0</span>           <span class="Comment"># Vector element (index)</span>
<span class="Keyword">let</span> <span class="Identifier">v</span> <span class="Operator">=</span> <span class="Identifier">site</span><span class="Punctuation">[</span><span class="Identifier">i</span><span class="Punctuation">,</span> <span class="Identifier">j</span><span class="Punctuation">]</span>      <span class="Comment"># Read matrix element</span></pre></p>

<h3 id="the-all-loop">The <tt class="docutils literal"><span class="pre">all</span></tt> Loop</h3><p>The <tt class="docutils literal"><span class="pre">all</span></tt> loop provides parallelized iteration over local sites:</p>
<p><pre class="listing"><span class="Comment"># Element initialization</span>
<span class="Keyword">for</span> <span class="Identifier">n</span> <span class="Keyword">in</span> <span class="Identifier">all</span> <span class="FloatNumber">0.</span><span class="Operator">.&lt;</span><span class="Identifier">local</span><span class="Operator">.</span><span class="Identifier">numSites</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">:</span>
  <span class="Keyword">var</span> <span class="Identifier">site</span> <span class="Operator">=</span> <span class="Identifier">local</span><span class="Operator">.</span><span class="Identifier">getSite</span><span class="Punctuation">(</span><span class="Identifier">n</span><span class="Punctuation">)</span>
  <span class="Keyword">for</span> <span class="Identifier">i</span> <span class="Keyword">in</span> <span class="FloatNumber">0.</span><span class="Operator">.&lt;</span><span class="DecNumber">3</span><span class="Punctuation">:</span>
    <span class="Keyword">for</span> <span class="Identifier">j</span> <span class="Keyword">in</span> <span class="FloatNumber">0.</span><span class="Operator">.&lt;</span><span class="DecNumber">3</span><span class="Punctuation">:</span>
      <span class="Identifier">site</span><span class="Punctuation">[</span><span class="Identifier">i</span><span class="Punctuation">,</span> <span class="Identifier">j</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="Keyword">if</span> <span class="Identifier">i</span> <span class="Operator">==</span> <span class="Identifier">j</span><span class="Punctuation">:</span> <span class="FloatNumber">1.0</span> <span class="Keyword">else</span><span class="Punctuation">:</span> <span class="FloatNumber">0.0</span>

<span class="Comment"># Arithmetic via LocalSiteProxy</span>
<span class="Keyword">for</span> <span class="Identifier">n</span> <span class="Keyword">in</span> <span class="Identifier">all</span> <span class="FloatNumber">0.</span><span class="Operator">.&lt;</span><span class="Identifier">localC</span><span class="Operator">.</span><span class="Identifier">numSites</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">:</span>
  <span class="Identifier">localC</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="Identifier">localA</span><span class="Operator">.</span><span class="Identifier">getSite</span><span class="Punctuation">(</span><span class="Identifier">n</span><span class="Punctuation">)</span> <span class="Operator">+</span> <span class="Identifier">localB</span><span class="Operator">.</span><span class="Identifier">getSite</span><span class="Punctuation">(</span><span class="Identifier">n</span><span class="Punctuation">)</span>
  <span class="Identifier">localC</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="Identifier">localA</span><span class="Operator">.</span><span class="Identifier">getSite</span><span class="Punctuation">(</span><span class="Identifier">n</span><span class="Punctuation">)</span> <span class="Operator">*</span> <span class="Identifier">localB</span><span class="Operator">.</span><span class="Identifier">getSite</span><span class="Punctuation">(</span><span class="Identifier">n</span><span class="Punctuation">)</span>
  <span class="Identifier">localC</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="FloatNumber">2.5</span> <span class="Operator">*</span> <span class="Identifier">localA</span><span class="Operator">.</span><span class="Identifier">getSite</span><span class="Punctuation">(</span><span class="Identifier">n</span><span class="Punctuation">)</span></pre></p>
<p>Supported proxy operations:</p>
<table border="1" class="docutils"><tr><th>Operation</th><th>Syntax</th></tr>
<tr><td>Addition</td><td><tt class="docutils literal"><span class="pre">localC[n] = a.getSite(n) + b.getSite(n)</span></tt></td></tr>
<tr><td>Subtraction</td><td><tt class="docutils literal"><span class="pre">localC[n] = a.getSite(n) - b.getSite(n)</span></tt></td></tr>
<tr><td>Multiplication</td><td><tt class="docutils literal"><span class="pre">localC[n] = a.getSite(n) * b.getSite(n)</span></tt></td></tr>
<tr><td>Scalar multiply</td><td><tt class="docutils literal"><span class="pre">localC[n] = 3.0 * a.getSite(n)</span></tt></td></tr>
<tr><td>Scalar add</td><td><tt class="docutils literal"><span class="pre">localC[n] = a.getSite(n) + 3.0</span></tt></td></tr>
<tr><td>Chaining</td><td><tt class="docutils literal"><span class="pre">localC[n] = a.getSite(n) * b.getSite(n) + c.getSite(n)</span></tt></td></tr>
</table>
<h2 id="tensorfieldview-deviceminusside">TensorFieldView (Device-Side)</h2><p><tt class="docutils literal"><span class="pre">TensorFieldView[L, T]</span></tt> wraps a <tt class="docutils literal"><span class="pre">LocalTensorField</span></tt> into device-side buffers with AoSoA memory layout.  This is the type that the <tt class="docutils literal"><span class="pre">each</span></tt> macro operates on.</p>

<h3 id="creation">Creation</h3><p><pre class="listing"><span class="Comment"># Read-only view (data uploaded to device)</span>
<span class="Keyword">var</span> <span class="Identifier">vA</span> <span class="Operator">=</span> <span class="Identifier">localA</span><span class="Operator">.</span><span class="Identifier">newTensorFieldView</span><span class="Punctuation">(</span><span class="Identifier">iokRead</span><span class="Punctuation">)</span>

<span class="Comment"># Write-only view (results downloaded from device after each loop)</span>
<span class="Keyword">var</span> <span class="Identifier">vC</span> <span class="Operator">=</span> <span class="Identifier">localC</span><span class="Operator">.</span><span class="Identifier">newTensorFieldView</span><span class="Punctuation">(</span><span class="Identifier">iokWrite</span><span class="Punctuation">)</span>

<span class="Comment"># Read-write view</span>
<span class="Keyword">var</span> <span class="Identifier">vRW</span> <span class="Operator">=</span> <span class="Identifier">localRW</span><span class="Operator">.</span><span class="Identifier">newTensorFieldView</span><span class="Punctuation">(</span><span class="Identifier">iokReadWrite</span><span class="Punctuation">)</span></pre></p>
<p>The <tt class="docutils literal"><span class="pre">IOKind</span></tt> enum controls data transfer:</p>
<table border="1" class="docutils"><tr><th>Kind</th><th>Upload</th><th>Download</th><th>Use case</th></tr>
<tr><td><tt class="docutils literal"><span class="pre">iokRead</span></tt></td><td>Yes</td><td>No</td><td>Input fields</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">iokWrite</span></tt></td><td>No</td><td>Yes</td><td>Output fields</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">iokReadWrite</span></tt></td><td>Yes</td><td>Yes</td><td>In-place updates</td></tr>
</table>
<h3 id="the-each-macro">The <tt class="docutils literal"><span class="pre">each</span></tt> Macro</h3><p>The <tt class="docutils literal"><span class="pre">each</span></tt> macro is the primary computation dispatch mechanism:</p>
<p><pre class="listing"><span class="Keyword">for</span> <span class="Identifier">n</span> <span class="Keyword">in</span> <span class="Identifier">each</span> <span class="FloatNumber">0.</span><span class="Operator">.&lt;</span><span class="Identifier">vC</span><span class="Operator">.</span><span class="Identifier">numSites</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">:</span>
  <span class="Identifier">vC</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="Identifier">vA</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span> <span class="Operator">+</span> <span class="Identifier">vB</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span></pre></p>
<p>This single line of code works across all three backends.  The macro:</p>
<ol class="simple"><li><strong>Parses</strong> the loop body AST at compile time</li>
<li><strong>Classifies</strong> each expression (copy, add, matmul, scalar-mul, etc.)</li>
<li><strong>Detects</strong> stencil neighbor patterns</li>
<li><strong>Generates</strong> backend-specific code:<ul class="simple"><li><strong>OpenCL</strong>: JIT-compiled OpenCL C kernel string</li>
<li><strong>SYCL</strong>: Calls to pre-compiled C++ kernel templates</li>
<li><strong>OpenMP</strong>: SIMD-vectorized C code with intrinsics</li>
</ul>
</li>
</ol>

<h3 id="supported-each-operations">Supported <tt class="docutils literal"><span class="pre">each</span></tt> Operations</h3><p><pre class="listing"><span class="Comment"># Copy</span>
<span class="Keyword">for</span> <span class="Identifier">n</span> <span class="Keyword">in</span> <span class="Identifier">each</span> <span class="FloatNumber">0.</span><span class="Operator">.&lt;</span><span class="Identifier">vC</span><span class="Operator">.</span><span class="Identifier">numSites</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">:</span>
  <span class="Identifier">vC</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="Identifier">vA</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span>

<span class="Comment"># Addition / subtraction</span>
<span class="Keyword">for</span> <span class="Identifier">n</span> <span class="Keyword">in</span> <span class="Identifier">each</span> <span class="FloatNumber">0.</span><span class="Operator">.&lt;</span><span class="Identifier">vC</span><span class="Operator">.</span><span class="Identifier">numSites</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">:</span>
  <span class="Identifier">vC</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="Identifier">vA</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span> <span class="Operator">+</span> <span class="Identifier">vB</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span>
  <span class="Identifier">vC</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="Identifier">vA</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span> <span class="Operator">-</span> <span class="Identifier">vB</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span>

<span class="Comment"># Matrix multiplication (R=2 fields)</span>
<span class="Keyword">for</span> <span class="Identifier">n</span> <span class="Keyword">in</span> <span class="Identifier">each</span> <span class="FloatNumber">0.</span><span class="Operator">.&lt;</span><span class="Identifier">vC</span><span class="Operator">.</span><span class="Identifier">numSites</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">:</span>
  <span class="Identifier">vC</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="Identifier">vA</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span> <span class="Operator">*</span> <span class="Identifier">vB</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span>

<span class="Comment"># Matrix-vector multiplication</span>
<span class="Keyword">for</span> <span class="Identifier">n</span> <span class="Keyword">in</span> <span class="Identifier">each</span> <span class="FloatNumber">0.</span><span class="Operator">.&lt;</span><span class="Identifier">vC</span><span class="Operator">.</span><span class="Identifier">numSites</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">:</span>
  <span class="Identifier">vOut</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="Identifier">vMat</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span> <span class="Operator">*</span> <span class="Identifier">vVec</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span>

<span class="Comment"># Scalar multiplication / addition</span>
<span class="Keyword">for</span> <span class="Identifier">n</span> <span class="Keyword">in</span> <span class="Identifier">each</span> <span class="FloatNumber">0.</span><span class="Operator">.&lt;</span><span class="Identifier">vC</span><span class="Operator">.</span><span class="Identifier">numSites</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">:</span>
  <span class="Identifier">vC</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="FloatNumber">3.0</span> <span class="Operator">*</span> <span class="Identifier">vA</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span>
  <span class="Identifier">vC</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="Identifier">vA</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span> <span class="Operator">+</span> <span class="FloatNumber">1.0</span>

<span class="Comment"># Chained expressions</span>
<span class="Keyword">for</span> <span class="Identifier">n</span> <span class="Keyword">in</span> <span class="Identifier">each</span> <span class="FloatNumber">0.</span><span class="Operator">.&lt;</span><span class="Identifier">vC</span><span class="Operator">.</span><span class="Identifier">numSites</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">:</span>
  <span class="Identifier">vC</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="Identifier">vA</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span> <span class="Operator">*</span> <span class="Identifier">vB</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span> <span class="Operator">+</span> <span class="Identifier">vC</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span>

<span class="Comment"># Stencil neighbor access</span>
<span class="Keyword">for</span> <span class="Identifier">n</span> <span class="Keyword">in</span> <span class="Identifier">each</span> <span class="FloatNumber">0.</span><span class="Operator">.&lt;</span><span class="Identifier">vC</span><span class="Operator">.</span><span class="Identifier">numSites</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">:</span>
  <span class="Keyword">let</span> <span class="Identifier">f</span> <span class="Operator">=</span> <span class="Identifier">stencil</span><span class="Operator">.</span><span class="Identifier">fwd</span><span class="Punctuation">(</span><span class="Identifier">n</span><span class="Punctuation">,</span> <span class="DecNumber">0</span><span class="Punctuation">)</span>
  <span class="Keyword">let</span> <span class="Identifier">b</span> <span class="Operator">=</span> <span class="Identifier">stencil</span><span class="Operator">.</span><span class="Identifier">bwd</span><span class="Punctuation">(</span><span class="Identifier">n</span><span class="Punctuation">,</span> <span class="DecNumber">0</span><span class="Punctuation">)</span>
  <span class="Identifier">vC</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="Identifier">vA</span><span class="Punctuation">[</span><span class="Identifier">f</span><span class="Punctuation">]</span> <span class="Operator">+</span> <span class="Identifier">vA</span><span class="Punctuation">[</span><span class="Identifier">b</span><span class="Punctuation">]</span>

<span class="Comment"># Element-level write</span>
<span class="Keyword">for</span> <span class="Identifier">n</span> <span class="Keyword">in</span> <span class="Identifier">each</span> <span class="FloatNumber">0.</span><span class="Operator">.&lt;</span><span class="Identifier">vC</span><span class="Operator">.</span><span class="Identifier">numSites</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">:</span>
  <span class="Identifier">vC</span><span class="Punctuation">[</span><span class="Identifier">n</span><span class="Punctuation">]</span><span class="Punctuation">[</span><span class="DecNumber">0</span><span class="Punctuation">,</span> <span class="DecNumber">0</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="FloatNumber">1.0</span></pre></p>

<h3 id="aosoa-memory-layout">AoSoA Memory Layout</h3><p>Device-side data uses Array of Structures of Arrays layout for optimal SIMD/GPU memory access:</p>
<p><pre class="listing">AoS:   [s0e0, s0e1, s1e0, s1e1, s2e0, s2e1, ...]

AoSoA (VW=4):
  Group 0: [s0e0, s1e0, s2e0, s3e0,   ← element 0
            s0e1, s1e1, s2e1, s3e1]   ← element 1
  Group 1: [s4e0, s5e0, s6e0, s7e0,
            s4e1, s5e1, s6e1, s7e1]</pre></p>
<p><strong>Index formula:</strong></p>
<p><pre class="listing">group = site / VectorWidth
lane  = site mod VectorWidth
index = group * (elemsPerSite * VectorWidth) + element * VectorWidth + lane</pre></p>
<p><tt class="docutils literal"><span class="pre">VectorWidth</span></tt> defaults to 8 (AVX-512) and can be set with <tt class="docutils literal"><span class="pre">-d:VectorWidth=N</span></tt>.</p>

<h2 id="site-tensor-types">Site Tensor Types</h2><p><tt class="docutils literal"><span class="pre">Vec[N, T]</span></tt> and <tt class="docutils literal"><span class="pre">Mat[N, M, T]</span></tt> represent tensors at a single lattice site with compile-time dimensions.  These are the types that appear inside <tt class="docutils literal"><span class="pre">each</span></tt> loop bodies and are translated to backend-specific code by the macro.</p>

<h3 id="type-aliases">Type Aliases</h3><table border="1" class="docutils"><tr><th>Alias</th><th>Full type</th></tr>
<tr><td><tt class="docutils literal"><span class="pre">Vec2f</span></tt></td><td><tt class="docutils literal"><span class="pre">Vec[2, float32]</span></tt></td></tr>
<tr><td><tt class="docutils literal"><span class="pre">Vec3d</span></tt></td><td><tt class="docutils literal"><span class="pre">Vec[3, float64]</span></tt></td></tr>
<tr><td><tt class="docutils literal"><span class="pre">Mat3d</span></tt></td><td><tt class="docutils literal"><span class="pre">Mat[3, 3, float64]</span></tt></td></tr>
<tr><td><tt class="docutils literal"><span class="pre">Mat4f</span></tt></td><td><tt class="docutils literal"><span class="pre">Mat[4, 4, float32]</span></tt></td></tr>
</table>
<h3 id="operations">Operations</h3><p><pre class="listing"><span class="Comment"># Vec operations</span>
<span class="Keyword">let</span> <span class="Identifier">v</span> <span class="Operator">=</span> <span class="Identifier">Vec3d</span><span class="Punctuation">(</span><span class="Identifier">data</span><span class="Punctuation">:</span> <span class="Punctuation">[</span><span class="FloatNumber">1.0</span><span class="Punctuation">,</span> <span class="FloatNumber">2.0</span><span class="Punctuation">,</span> <span class="FloatNumber">3.0</span><span class="Punctuation">]</span><span class="Punctuation">)</span>
<span class="Keyword">let</span> <span class="Identifier">w</span> <span class="Operator">=</span> <span class="Identifier">Vec3d</span><span class="Punctuation">(</span><span class="Identifier">data</span><span class="Punctuation">:</span> <span class="Punctuation">[</span><span class="FloatNumber">4.0</span><span class="Punctuation">,</span> <span class="FloatNumber">5.0</span><span class="Punctuation">,</span> <span class="FloatNumber">6.0</span><span class="Punctuation">]</span><span class="Punctuation">)</span>
<span class="Keyword">let</span> <span class="Identifier">sum</span> <span class="Operator">=</span> <span class="Identifier">v</span> <span class="Operator">+</span> <span class="Identifier">w</span>
<span class="Keyword">let</span> <span class="Identifier">scaled</span> <span class="Operator">=</span> <span class="FloatNumber">2.0</span> <span class="Operator">*</span> <span class="Identifier">v</span>
<span class="Keyword">let</span> <span class="Identifier">d</span> <span class="Operator">=</span> <span class="Identifier">dot</span><span class="Punctuation">(</span><span class="Identifier">v</span><span class="Punctuation">,</span> <span class="Identifier">w</span><span class="Punctuation">)</span>

<span class="Comment"># Mat operations</span>
<span class="Keyword">let</span> <span class="Identifier">m</span> <span class="Operator">=</span> <span class="Identifier">identity</span><span class="Punctuation">[</span><span class="DecNumber">3</span><span class="Punctuation">,</span> <span class="Identifier">float64</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Punctuation">)</span>
<span class="Keyword">let</span> <span class="Identifier">mt</span> <span class="Operator">=</span> <span class="Identifier">m</span><span class="Operator">.</span><span class="Identifier">transpose</span><span class="Punctuation">(</span><span class="Punctuation">)</span>
<span class="Keyword">let</span> <span class="Identifier">tr</span> <span class="Operator">=</span> <span class="Identifier">m</span><span class="Operator">.</span><span class="Identifier">trace</span><span class="Punctuation">(</span><span class="Punctuation">)</span>
<span class="Keyword">let</span> <span class="Identifier">prod</span> <span class="Operator">=</span> <span class="Identifier">m</span> <span class="Operator">*</span> <span class="Identifier">m</span>
<span class="Keyword">let</span> <span class="Identifier">mv</span> <span class="Operator">=</span> <span class="Identifier">m</span> <span class="Operator">*</span> <span class="Identifier">v</span></pre></p>

<h2 id="transport-infrastructure">Transport Infrastructure</h2>
<h3 id="shifter-singleminusrank">Shifter (Single-Rank)</h3><p><tt class="docutils literal"><span class="pre">Shifter[D, T]</span></tt> performs field shifts within device-side views, using halo buffers for boundary communication:</p>
<p><pre class="listing"><span class="Keyword">let</span> <span class="Identifier">localGeom</span> <span class="Operator">=</span> <span class="Punctuation">[</span><span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">4</span><span class="Punctuation">]</span>  <span class="Comment"># Local lattice after MPI decomposition</span>
<span class="Keyword">var</span> <span class="Identifier">shifter</span> <span class="Operator">=</span> <span class="Identifier">newShifter</span><span class="Punctuation">[</span><span class="DecNumber">4</span><span class="Punctuation">,</span> <span class="Identifier">float64</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Identifier">localGeom</span><span class="Punctuation">,</span> <span class="Identifier">dim</span><span class="Operator">=</span><span class="DecNumber">0</span><span class="Punctuation">,</span> <span class="Identifier">len</span><span class="Operator">=</span><span class="DecNumber">1</span><span class="Punctuation">)</span>

<span class="Comment"># Create shifters for all dimensions</span>
<span class="Keyword">var</span> <span class="Identifier">fwd</span> <span class="Operator">=</span> <span class="Identifier">newShifters</span><span class="Punctuation">[</span><span class="DecNumber">4</span><span class="Punctuation">,</span> <span class="Identifier">float64</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Identifier">localGeom</span><span class="Punctuation">,</span> <span class="Identifier">len</span><span class="Operator">=</span><span class="DecNumber">1</span><span class="Punctuation">)</span>
<span class="Keyword">var</span> <span class="Identifier">bwd</span> <span class="Operator">=</span> <span class="Identifier">newBackwardShifters</span><span class="Punctuation">[</span><span class="DecNumber">4</span><span class="Punctuation">,</span> <span class="Identifier">float64</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Identifier">localGeom</span><span class="Punctuation">,</span> <span class="Identifier">len</span><span class="Operator">=</span><span class="DecNumber">1</span><span class="Punctuation">)</span></pre></p>

<h3 id="transporter-gauge-link-multiplication">Transporter (Gauge Link Multiplication)</h3><p><tt class="docutils literal"><span class="pre">Transporter[D, U, F]</span></tt> performs parallel transport with gauge link multiplication (covariant shifts):</p>
<p><pre class="listing"><span class="Keyword">var</span> <span class="Identifier">transporter</span> <span class="Operator">=</span> <span class="Identifier">newTransporter</span><span class="Punctuation">[</span><span class="DecNumber">4</span><span class="Punctuation">,</span> <span class="Identifier">GaugeType</span><span class="Punctuation">,</span> <span class="Identifier">FermionType</span><span class="Punctuation">]</span><span class="Punctuation">(</span>
  <span class="Identifier">localGeom</span><span class="Punctuation">,</span> <span class="Identifier">gaugeField</span><span class="Punctuation">,</span> <span class="Identifier">dim</span><span class="Operator">=</span><span class="DecNumber">0</span><span class="Punctuation">,</span> <span class="Identifier">len</span><span class="Operator">=</span><span class="DecNumber">1</span>
<span class="Punctuation">)</span></pre></p>

<h3 id="globalshifter-mpiminuslevel">GlobalShifter (MPI-Level)</h3><p><tt class="docutils literal"><span class="pre">GlobalShifter[D, R, L, T]</span></tt> performs distributed shifts using GA ghost exchange across MPI boundaries:</p>
<p><pre class="listing"><span class="Identifier">parallel</span><span class="Punctuation">:</span>
  <span class="Keyword">let</span> <span class="Identifier">lat</span> <span class="Operator">=</span> <span class="Identifier">newSimpleCubicLattice</span><span class="Punctuation">(</span><span class="Punctuation">[</span><span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">8</span><span class="Punctuation">,</span> <span class="DecNumber">16</span><span class="Punctuation">]</span><span class="Punctuation">,</span> <span class="Punctuation">[</span><span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">4</span><span class="Punctuation">]</span><span class="Punctuation">,</span> <span class="Punctuation">[</span><span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">]</span><span class="Punctuation">)</span>
  
  <span class="Keyword">block</span><span class="Punctuation">:</span>
    <span class="Keyword">var</span> <span class="Identifier">src</span>  <span class="Operator">=</span> <span class="Identifier">lat</span><span class="Operator">.</span><span class="Identifier">newTensorField</span><span class="Punctuation">(</span><span class="Punctuation">[</span><span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">]</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">float64</span>
    <span class="Keyword">var</span> <span class="Identifier">dest</span> <span class="Operator">=</span> <span class="Identifier">lat</span><span class="Operator">.</span><span class="Identifier">newTensorField</span><span class="Punctuation">(</span><span class="Punctuation">[</span><span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">]</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">float64</span>
    
    <span class="Comment"># Forward shift in t-dimension</span>
    <span class="Keyword">let</span> <span class="Identifier">shifter</span> <span class="Operator">=</span> <span class="Identifier">newGlobalShifter</span><span class="Punctuation">(</span><span class="Identifier">src</span><span class="Punctuation">,</span> <span class="Identifier">dim</span><span class="Operator">=</span><span class="DecNumber">3</span><span class="Punctuation">,</span> <span class="Identifier">len</span><span class="Operator">=</span><span class="DecNumber">1</span><span class="Punctuation">)</span>
    <span class="Identifier">shifter</span><span class="Operator">.</span><span class="Identifier">apply</span><span class="Punctuation">(</span><span class="Identifier">src</span><span class="Punctuation">,</span> <span class="Identifier">dest</span><span class="Punctuation">)</span>   <span class="Comment"># dest[x] = src[x + e_t]</span>
    
    <span class="Comment"># Discrete Laplacian</span>
    <span class="Keyword">var</span> <span class="Identifier">lap</span> <span class="Operator">=</span> <span class="Identifier">lat</span><span class="Operator">.</span><span class="Identifier">newTensorField</span><span class="Punctuation">(</span><span class="Punctuation">[</span><span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">]</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">float64</span>
    <span class="Keyword">var</span> <span class="Identifier">scratch</span> <span class="Operator">=</span> <span class="Identifier">lat</span><span class="Operator">.</span><span class="Identifier">newTensorField</span><span class="Punctuation">(</span><span class="Punctuation">[</span><span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">1</span><span class="Punctuation">]</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">float64</span>
    <span class="Identifier">discreteLaplacian</span><span class="Punctuation">(</span><span class="Identifier">src</span><span class="Punctuation">,</span> <span class="Identifier">lap</span><span class="Punctuation">,</span> <span class="Identifier">scratch</span><span class="Punctuation">)</span></pre></p>

<h3 id="two-transport-layers">Two Transport Layers</h3><table border="1" class="docutils"><tr><th>Layer</th><th>Operates On</th><th>Communication</th></tr>
<tr><td><tt class="docutils literal"><span class="pre">GlobalShifter</span></tt></td><td><tt class="docutils literal"><span class="pre">TensorField</span></tt></td><td>GA ghost exchange (MPI)</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">Shifter</span></tt> / <tt class="docutils literal"><span class="pre">Transporter</span></tt></td><td><tt class="docutils literal"><span class="pre">TensorFieldView</span></tt></td><td>Device-side halo buffers</td></tr>
</table><p>Use <tt class="docutils literal"><span class="pre">GlobalShifter</span></tt> for setup, I/O, and measurement code.  Use <tt class="docutils literal"><span class="pre">Shifter</span></tt>/<tt class="docutils literal"><span class="pre">Transporter</span></tt> for on-device computation inside <tt class="docutils literal"><span class="pre">each</span></tt> loops.</p>

<h2 id="module-reference">Module Reference</h2><table border="1" class="docutils"><tr><th>Module</th><th>Description</th></tr>
<tr><td><a class="reference external" href="tensor/globaltensor.html">tensor/globaltensor</a></td><td>Distributed tensor fields and GlobalShifter</td></tr>
<tr><td><a class="reference external" href="tensor/localtensor.html">tensor/localtensor</a></td><td>Local host buffer with contiguous AoS layout</td></tr>
<tr><td><a class="reference external" href="tensor/tensorview.html">tensor/tensorview</a></td><td>Device-side views and <tt class="docutils literal"><span class="pre">each</span></tt> macro dispatch</td></tr>
<tr><td><a class="reference external" href="tensor/sitetensor.html">tensor/sitetensor</a></td><td><tt class="docutils literal"><span class="pre">Vec[N,T]</span></tt> and <tt class="docutils literal"><span class="pre">Mat[N,M,T]</span></tt> site types</td></tr>
<tr><td><a class="reference external" href="tensor/transporter.html">tensor/transporter</a></td><td>Single-rank Shifter and Transporter</td></tr>
</table>


      <div class="twelve-columns footer">
        <span class="nim-sprite"></span>
        <br>
        <small style="color: var(--hint);">Made with Nim. Generated: 2026-02-07 06:49:56 UTC</small>
      </div>
    </div>
  </div>
  
</body>
</html>
